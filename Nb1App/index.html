<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinic Manager Pro V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --primary-dark: #2d47c9; --success: #06d6a0; --warning: #ffd166; --danger: #ef476f; --accent: #f72585; --bg: #f4f6fb; --surface: #ffffff; --text: #1a1d2e; --text2: #6c757d; --border: #e2e6f0; --rs: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; padding-bottom: 80px; }

        /* LOADER & LOGIN */
        #global-loader { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 50%, #1a1d2e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s; }
        .loader-logo { font-family: 'Prompt', sans-serif; font-size: 26px; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .loader-bar { width: 220px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .loader-fill { height: 100%; width: 50%; background: var(--primary); animation: loadAnim 1.5s infinite; }
        @keyframes loadAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 50%, #1a1d2e 100%); display: flex; align-items: center; justify-content: center; z-index: 9000; padding: 16px; }
        .login-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12); border-radius: 24px; padding: 40px; width: 100%; max-width: 380px; text-align: center; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; text-align: center; font-size: 16px; transition: 0.3s; }
        .login-input:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.15); }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; font-family: 'Prompt', sans-serif; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4); }

        /* UI COMPONENTS */
        .nav { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .nav-inner { display: flex; align-items: center; padding: 0 10px; overflow-x: auto; max-width: 800px; margin: 0 auto; }
        .nav-tab { padding: 16px 12px; cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 14px; font-weight: 600; color: var(--text2); white-space: nowrap; transition: 0.3s; }
        .nav-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        
        .org-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; padding: 20px; display: flex; align-items: center; gap: 15px; border-radius: 0 0 16px 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sec { background: var(--surface); border-radius: var(--rs); padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .sec-label { font-family: 'Prompt', sans-serif; font-weight: 700; color: var(--primary); font-size: 15px; margin-bottom: 12px; border-bottom: 2px solid #f0f4ff; padding-bottom: 8px; }
        .fc { width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fafbfe; margin-bottom: 10px; transition: 0.3s; }
        .frow { display: flex; gap: 12px; flex-wrap: wrap; }
        .fg { flex: 1; min-width: 120px; display: flex; flex-direction: column; }
        .fg label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; }
        
        /* CARD & LIST STYLES */
        .app-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 12px; transition: 0.2s; position: relative; overflow: hidden; }
        .app-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary); }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .app-name { font-weight: 700; font-size: 16px; color: var(--text); }
        .app-detail { font-size: 14px; color: var(--text2); margin-bottom: 8px; }
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
        .btn-expand { background: #f1f3f5; color: var(--text2); width: 100%; margin-top: 10px; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }
        
        .history-panel { background: #f8f9fa; margin-top: 10px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: none; font-size: 13px; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6; }
        .history-item:last-child { border-bottom: none; }
        .badge-debt { background: #ffcdd2; color: #c62828; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .badge-status { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        /* SUMMARY TABLE */
        .tbl { width: 100%; border-collapse: collapse; font-size: 14px; }
        .tbl th { text-align: left; padding: 10px; background: #f8f9fa; color: var(--text2); font-weight: 600; border-bottom: 2px solid var(--border); }
        .tbl td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1a1d2e; color: #fff; padding: 14px 28px; border-radius: 30px; opacity: 0; transition: 0.4s; z-index: 10000; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="global-loader"><div class="loader-logo">üè• Clinic Manager Pro</div><div class="loader-bar"><div class="loader-fill"></div></div></div>

<!-- Login -->
<div id="login-screen">
    <div class="login-box">
        <div class="login-logo" style="font-family: 'Prompt'; font-size: 24px; color: #fff; font-weight: 700; margin-bottom: 5px;">üè• Clinic Manager Pro</div>
        <div class="login-sub" style="color: #adb5bd; font-size: 14px; margin-bottom: 30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£</div>
        <input class="login-input" id="login-username" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
        <input class="login-input" id="login-pin" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PIN)" maxlength="10">
        <button class="login-btn" id="btn-login" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="login-err" style="color:#ef476f; font-size:14px; font-weight:600; margin-top:15px; min-height: 20px;"></div>
    </div>
</div>

<!-- Nav -->
<nav class="nav" id="main-nav" style="display:none">
    <div class="nav-inner">
        <div class="nav-tab active" id="tab-form" onclick="switchPage('form', this)">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="nav-tab" id="tab-appt" onclick="switchPage('appointments', this)">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
        <div class="nav-tab" id="tab-cust" onclick="switchPage('customers', this)">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-tab" id="tab-summary" onclick="switchPage('summary', this)">üìä ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="nav-tab" id="tab-settings" style="display:none;" onclick="switchPage('settings', this)">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        <div style="margin-left:auto; font-weight:700; color:var(--primary); font-size: 14px;" id="nav-display-name"></div>
        <button onclick="location.reload()" style="margin-left:10px; background:none; border:none; cursor:pointer;">üö™</button>
    </div>
</nav>

<!-- Content -->
<div id="main-content" style="display:none; padding: 0 15px; max-width: 800px; margin: 0 auto;">
    <div class="org-banner" style="margin-top: 15px;">
        <div style="font-size: 24px;">‚ú®</div>
        <div class="org-name" style="font-family: 'Prompt'; font-size: 18px; font-weight: 600;">NT Design Clinic System</div>
    </div>

    <!-- PAGE: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
    <div id="page-form" class="page active">
        <div class="sec">
            <div class="sec-label">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="frow">
                <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠ *</label><input class="fc" id="f-fn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"></div>
                <div class="fg"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fc" id="f-ln" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
            </div>
            <input class="fc" id="f-ph" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (08x-xxx-xxxx)" type="tel">
            <div style="margin-top:5px; display:flex; align-items:center; gap:10px; padding:12px; background:#f0fff8; border-radius:8px; border:1px solid #b2dfdb">
                <input type="checkbox" id="f-pdpa" style="width:20px; height:20px; accent-color: var(--success);">
                <span style="font-size:13px; color:#047857; font-weight:600;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (PDPA)</span>
            </div>
            <div class="btn-expand" onclick="toggleExtra()">‚ûï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß)</div>
            <div id="extra-body" style="display:none; padding-top:10px;">
                <div class="frow">
                    <div class="fg"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input class="fc" id="f-age" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 25"></div>
                    <div class="fg"><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input class="fc" id="f-disease" placeholder="‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á"></div>
                </div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-label">üíâ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div id="item-list"></div>
            <button class="login-btn" style="background:transparent; border:1px dashed var(--primary); color:var(--primary); margin-top:5px;" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <div class="frow" style="margin-top:20px; align-items: flex-end;">
                <div class="fg"><label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏Ñ‡∏™ *</label><select class="fc" id="f-sale1"></select></div>
                <div class="fg"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label><input class="fc" id="f-total" type="text" readonly style="background:#e9ecef; font-weight:700;"></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-label">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</div>
            <input type="file" id="f-photo" accept="image/*" onchange="uploadToDrive(this)" style="display:block; width:100%;">
            <div id="upload-status" style="margin-top:5px; font-size:13px;"></div>
        </div>

        <button class="login-btn" id="btn-save" style="margin-bottom:20px;" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    </div>

    <!-- PAGE: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
    <div id="page-appointments" class="page">
        <div class="sec" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="sec-label" style="margin:0;">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
            <button class="btn-sm" style="background:var(--primary); color:#fff;" onclick="openApptModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î</button>
        </div>
        <div id="appt-list"><div style="text-align:center; color:var(--text2); padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
    </div>

    <!-- PAGE: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥) -->
    <div id="page-customers" class="page">
        <div class="sec">
            <div class="sec-label">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <input class="fc" id="cust-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." oninput="searchCustomer()">
            <div id="cust-results" style="margin-top:10px;"></div>
        </div>
        <div id="cust-detail-area"></div>
    </div>

    <!-- PAGE: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
    <div id="page-summary" class="page">
        <div class="sec">
            <div class="sec-label">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø</div>
            <div class="frow" style="align-items:center; margin-bottom:15px;">
                <div class="fg" style="flex:0 0 150px;"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" class="fc" id="sum-month" onchange="loadSummary()"></div>
                <button class="btn-sm" style="background:var(--primary); color:#fff; height:42px; margin-top:18px;" onclick="loadSummary()">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:#e3f2fd; padding:15px; border-radius:12px; text-align:center;">
                    <div style="font-size:12px; color:#1565c0;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                    <div style="font-size:24px; font-weight:700; color:#0d47a1;" id="sum-total">0</div>
                </div>
                <div style="flex:1; background:#f3e5f5; padding:15px; border-radius:12px; text-align:center;">
                    <div style="font-size:12px; color:#6a1b9a;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
                    <div style="font-size:24px; font-weight:700; color:#4a148c;" id="sum-count">0</div>
                </div>
            </div>

            <div class="sec-label" style="font-size:14px; border:none; margin-bottom:5px;">üèÜ ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Commission Base)</div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th style="text-align:right;">‡πÄ‡∏Ñ‡∏™</th><th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th></tr></thead>
                    <tbody id="sum-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PAGE: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) -->
    <div id="page-settings" class="page">
        <!-- Telegram -->
        <div class="sec" style="border-left: 4px solid var(--accent);">
            <div class="sec-label">ü§ñ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram</div>
            <div class="fg"><label>Bot Token</label><input class="fc" id="set-tg-token" placeholder="Bot Token"></div>
            <div class="fg"><label>Chat ID</label><input class="fc" id="set-tg-chatid" placeholder="Chat ID"></div>
            <label style="font-size:14px;"><input type="checkbox" id="set-tg-alert-new"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</label>
            <button class="login-btn" style="margin-top:10px; font-size:14px; padding:10px;" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Telegram</button>
        </div>

        <!-- Staff Management -->
        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="sec-label" style="margin:0;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                <button class="btn-sm" style="background:var(--success); color:#fff;" onclick="openStaffModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="staff-table"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- MODALS -->
<div id="modal-appt" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:12px;">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3>
        <input class="fc" id="apt-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)" onchange="findCustomer(this.value)">
        <div class="frow"><div class="fg"><input class="fc" id="apt-fn" placeholder="‡∏ä‡∏∑‡πà‡∏≠"></div><div class="fg"><input class="fc" id="apt-ln" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div></div>
        <div class="frow"><div class="fg"><input type="date" class="fc" id="apt-date"></div><div class="fg"><input type="time" class="fc" id="apt-time"></div></div>
        <textarea class="fc" id="apt-detail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
        <div class="frow"><div class="fg"><select class="fc" id="apt-dr"></select></div><div class="fg"><select class="fc" id="apt-bt"></select></div></div>
        <div style="display:flex; gap:10px;"><button class="login-btn" style="background:#ddd; color:#000;" onclick="closeApptModal()">‡∏õ‡∏¥‡∏î</button><button class="login-btn" onclick="saveAppointment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
</div>

<div id="modal-staff" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:350px; padding:20px; border-radius:12px;">
        <h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
        <input class="fc" id="stf-user" placeholder="Username (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö)">
        <input class="fc" id="stf-pin" placeholder="PIN (4 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="4" type="tel">
        <input class="fc" id="stf-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (Display Name)">
        <select class="fc" id="stf-role">
            <option value="Sales">Sales (‡πÄ‡∏ã‡∏•‡∏•‡πå)</option>
            <option value="BT">BT (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢/‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡πå)</option>
            <option value="Dr">Dr (‡πÅ‡∏û‡∏ó‡∏¢‡πå)</option>
            <option value="Manager">Manager (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)</option>
            <option value="Admin">Admin (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</option>
        </select>
        <div style="display:flex; gap:10px;"><button class="login-btn" style="background:#ddd; color:#000;" onclick="document.getElementById('modal-staff').style.display='none'">‡∏õ‡∏¥‡∏î</button><button class="login-btn" onclick="addStaff()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
</div>

<div id="toast">‚úÖ ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

<script>
    let currentUser = null;
    let staffList = [];

    window.onload = () => {
        setTimeout(() => { document.getElementById('global-loader').style.display = 'none'; }, 800);
        addItemRow();
        document.getElementById('sum-month').value = new Date().toISOString().slice(0, 7);
    };

    async function apiCall(action, payload) {
        try {
            const res = await fetch('/.netlify/functions/api', { method: 'POST', body: JSON.stringify({ action, payload }) });
            return await res.json();
        } catch (e) { return { success: false, message: 'Connection Error' }; }
    }

    async function doLogin() {
        const username = document.getElementById('login-username').value;
        const pin = document.getElementById('login-pin').value;
        const res = await apiCall('login', { username, pin });
        if (res.success) {
            currentUser = res.user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'block';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('nav-display-name').textContent = currentUser.display_name;
            await initSystem();
        } else {
            document.getElementById('login-err').textContent = res.message;
        }
    }

    async function initSystem() {
        // Staff Loading
        const res = await apiCall('get_staff', {});
        if (res.success) { staffList = res.staff; renderStaffSelects(); }
        
        // Permission Check
        const role = currentUser.role;
        if (['Owner', 'Admin', 'Manager', 'Front'].includes(role)) {
            document.getElementById('tab-settings').style.display = 'block';
            loadSettings(); loadAllStaff();
        }
        
        // Auto-select sale for operation staff
        if (['Sales', 'BT', 'Dr'].includes(role)) {
            const myStaff = staffList.find(s => s.id === currentUser.id);
            if (myStaff) {
                const s = document.getElementById('f-sale1');
                s.value = myStaff.id; s.disabled = true; s.style.background = '#e9ecef';
            }
        }
        loadAppointments();
    }

    // --- FORM ---
    function addItemRow() {
        const div = document.createElement('div');
        div.className = 'frow item-row';
        div.innerHTML = `<div class="fg" style="flex:2"><input class="fc item-name" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"></div><div class="fg" style="flex:1"><input class="fc item-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" oninput="calcTotal()"></div><button onclick="this.parentElement.remove(); calcTotal()" style="color:red; background:none; border:none;">x</button>`;
        document.getElementById('item-list').appendChild(div);
    }
    function calcTotal() {
        let sum = 0; document.querySelectorAll('.item-row').forEach(r => sum += +(r.querySelector('.item-price').value || 0));
        document.getElementById('f-total').value = sum.toLocaleString(); return sum;
    }
    async function saveOrder() {
        const items = [];
        document.querySelectorAll('.item-row').forEach(r => { if(r.querySelector('.item-name').value) items.push({ name: r.querySelector('.item-name').value, price: +r.querySelector('.item-price').value }); });
        
        const payload = {
            firstName: document.getElementById('f-fn').value, lastName: document.getElementById('f-ln').value,
            phone: document.getElementById('f-ph').value, age: document.getElementById('f-age').value,
            disease: document.getElementById('f-disease').value, pdpa: document.getElementById('f-pdpa').checked,
            items: items, totalPrice: calcTotal(), saleStaffId: document.getElementById('f-sale1').value,
            saleStaffName: document.getElementById('f-sale1').selectedOptions[0].text,
            imageUrl: document.getElementById('f-photo').getAttribute('data-link'), currentUserId: currentUser.id
        };
        const res = await apiCall('save_order', payload);
        if (res.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); setTimeout(() => location.reload(), 1500); }
    }

    // --- CUSTOMERS ---
    async function searchCustomer() {
        const q = document.getElementById('cust-search').value;
        if(q.length < 2) return;
        const res = await apiCall('search_customers', { query: q });
        let html = '';
        if(res.success) {
            res.customers.forEach(c => {
                html += `<div class="app-card" onclick="loadCustomerDetail(${c.id})" style="cursor:pointer; border-left:4px solid var(--accent);">
                    <div class="app-name">${c.first_name} ${c.last_name || ''}</div>
                    <div class="app-detail">üìû ${c.phone}</div>
                </div>`;
            });
        }
        document.getElementById('cust-results').innerHTML = html;
    }
    
    async function loadCustomerDetail(cid) {
        const res = await apiCall('get_customer_full_detail', { customerId: cid });
        if(!res.success) return;
        const c = res.customer;
        
        // Orders HTML
        let ordersHtml = '';
        res.orders.forEach(o => {
            const date = new Date(o.created_at).toLocaleDateString('th-TH');
            const items = o.items.map(i=>`${i.name}`).join(', ');
            // Filter payments for this order
            const pays = res.payments.filter(p => p.order_id === o.id);
            const paid = pays.reduce((s, p) => s + parseFloat(p.amount), 0);
            
            ordersHtml += `
            <div style="background:#f8f9fa; border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; font-weight:700; color:var(--primary-dark);">
                    <span>üìÖ ${date}</span> <span>${parseFloat(o.total_price).toLocaleString()}‡∏ø</span>
                </div>
                <div style="font-size:13px; color:#555;">${items}</div>
                <div style="font-size:12px; margin-top:5px;">‡∏î‡∏π‡πÅ‡∏•‡πÇ‡∏î‡∏¢: ${o.sale_name || '-'}</div>
                <div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc; font-size:12px;">
                    <div>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß: <span style="color:var(--success); font-weight:700;">${paid.toLocaleString()}‡∏ø</span> (‡∏Ñ‡πâ‡∏≤‡∏á: ${(o.total_price - paid).toLocaleString()}‡∏ø)</div>
                    ${pays.map(p => `<div>‚Ä¢ ‡∏à‡πà‡∏≤‡∏¢ ${parseFloat(p.amount).toLocaleString()} (${new Date(p.created_at).toLocaleDateString()})</div>`).join('')}
                </div>
            </div>`;
        });

        const html = `
        <div style="background:#fff; padding:20px; border-radius:12px; border:1px solid var(--primary); margin-top:20px;">
            <h3 style="color:var(--primary); margin-bottom:10px;">${c.first_name} ${c.last_name} (‡∏≠‡∏≤‡∏¢‡∏∏ ${c.age||'-'})</h3>
            <div style="margin-bottom:15px;">
                <div>üìû ${c.phone}</div>
                <div style="color:red;">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${c.disease || '-'}</div>
                <div class="badge-debt" style="display:inline-block; margin-top:5px;">‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°: ${res.total_debt.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            
            <div class="sec-label">üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™ (${res.orders.length})</div>
            ${ordersHtml || '<div style="color:#aaa;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</div>'}
            
            <div class="sec-label" style="margin-top:20px;">üíÜ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥ (${res.usage.length})</div>
            ${res.usage.map(u => `<div class="history-item"><span>${new Date(u.usage_date).toLocaleDateString()} - ${u.details}</span><span style="font-size:11px;">${u.dr_name||''}</span></div>`).join('')}
        </div>`;
        document.getElementById('cust-detail-area').innerHTML = html;
        document.getElementById('cust-results').innerHTML = ''; // Clear search list
    }

    // --- SUMMARY ---
    async function loadSummary() {
        const m = document.getElementById('sum-month').value;
        const res = await apiCall('get_sales_summary', { month: m });
        if(res.success) {
            let total = 0; let count = 0;
            res.dailySales.forEach(d => total += parseFloat(d.total));
            res.staffPerf.forEach(s => count += parseInt(s.order_count));
            
            document.getElementById('sum-total').textContent = total.toLocaleString();
            document.getElementById('sum-count').textContent = count;
            
            let html = '';
            res.staffPerf.forEach(s => {
                html += `<tr><td>${s.display_name}</td><td style="text-align:right;">${s.order_count}</td><td style="text-align:right;">${parseFloat(s.total_sales).toLocaleString()}</td></tr>`;
            });
            document.getElementById('sum-table').innerHTML = html;
        }
    }

    // --- SETTINGS ---
    async function loadAllStaff() {
        const res = await apiCall('get_all_users', {});
        let html = '';
        if(res.success) {
            res.users.forEach(u => {
                html += `<tr><td>${u.display_name} <div style="font-size:11px; color:#aaa;">@${u.username}</div></td><td><span class="badge-status" style="background:#eee;">${u.role}</span></td><td><button class="btn-sm" style="color:red;" onclick="delStaff(${u.id})">‡∏•‡∏ö</button></td></tr>`;
            });
        }
        document.getElementById('staff-table').innerHTML = html;
    }
    
    async function addStaff() {
        const payload = {
            subAction: 'add',
            username: document.getElementById('stf-user').value,
            pin: document.getElementById('stf-pin').value,
            name: document.getElementById('stf-name').value,
            role: document.getElementById('stf-role').value
        };
        const res = await apiCall('manage_staff', payload);
        if(res.success) { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); document.getElementById('modal-staff').style.display='none'; loadAllStaff(); }
    }
    
    async function delStaff(id) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?')) return;
        await apiCall('manage_staff', { subAction: 'delete', id });
        loadAllStaff();
    }
    
    async function loadSettings() {
        const res = await apiCall('get_settings', {});
        if (res.success && res.settings) {
            document.getElementById('set-tg-token').value = res.settings.tg_token||'';
            document.getElementById('set-tg-chatid').value = res.settings.tg_chat_id||'';
            document.getElementById('set-tg-alert-new').checked = res.settings.alert_new_order;
        }
    }
    async function saveSettings() {
        const p = { tg_token: document.getElementById('set-tg-token').value, tg_chat_id: document.getElementById('set-tg-chatid').value, alert_new_order: document.getElementById('set-tg-alert-new').checked };
        const res = await apiCall('save_settings', p);
        if(res.success) showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    }

    // --- SHARED ---
    function renderStaffSelects() {
        const sales = staffList.filter(s=>['Sales','Manager','Owner','Admin'].includes(s.role)).map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('f-sale1').innerHTML = '<option value="">-‡πÄ‡∏•‡∏∑‡∏≠‡∏Å-</option>' + sales;
        document.getElementById('apt-dr').innerHTML = '<option value="">-</option>' + staffList.filter(s=>s.role==='Dr').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('apt-bt').innerHTML = '<option value="">-</option>' + staffList.filter(s=>s.role==='BT').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
    }
    // Appointments logic same as before (simplified for brevity, assume loadAppointments exists)
    async function loadAppointments() {
        const res = await apiCall('get_appointments', {});
        let html = '';
        if(res.success) {
            res.appointments.forEach(a => {
                const time = a.appointment_time.substring(0,5);
                html += `<div class="app-card"><div class="app-header"><div class="app-time">${time}</div><div class="app-name">${a.first_name} ${a.last_name||''}</div></div><div class="app-detail">üìã ${a.service_details}</div><div class="app-detail">üìû ${a.phone}</div></div>`;
            });
        }
        document.getElementById('appt-list').innerHTML = html || '<div style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>';
    }
    function openApptModal() { document.getElementById('modal-appt').style.display='flex'; }
    function closeApptModal() { document.getElementById('modal-appt').style.display='none'; }
    async function saveAppointment() {
        // Logic similar to previous version
        const payload = { firstName: document.getElementById('apt-fn').value, lastName: document.getElementById('apt-ln').value, phone: document.getElementById('apt-phone').value, date: document.getElementById('apt-date').value, time: document.getElementById('apt-time').value, details: document.getElementById('apt-detail').value, drId: document.getElementById('apt-dr').value, btId: document.getElementById('apt-bt').value, currentUserId: currentUser.id };
        const res = await apiCall('save_appointment', payload);
        if(res.success) { showToast('‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); closeApptModal(); loadAppointments(); }
    }
    function openStaffModal() { document.getElementById('modal-staff').style.display='flex'; }
    function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active'); el.classList.add('active');
    }
    function toggleExtra() { const b = document.getElementById('extra-body'); b.style.display = b.style.display==='block'?'none':'block'; }
    function showToast(m) { const t = document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    async function uploadToDrive(input) {
        const file = input.files[0]; if(!file) return;
        document.getElementById('upload-status').textContent='Uploading...';
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Slip_${Date.now()}.jpg` });
            if(res.success) { input.setAttribute('data-link', res.link); document.getElementById('upload-status').textContent='‚úÖ'; }
        };
        r.readAsDataURL(file);
    }
</script>
</body>
</html>