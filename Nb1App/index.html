<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinic Manager Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; --primary-dark: #2d47c9; 
            --success: #06d6a0; --warning: #ffd166; --danger: #ef476f; --accent: #f72585; 
            --bg: #f4f6fb; --surface: #ffffff; 
            --text: #1a1d2e; --text2: #6c757d; --border: #e2e6f0; --rs: 12px; 
            --nav-bg: #ffffff; --nav-text: #6c757d; --board-text: #1a1d2e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--board-text); padding-bottom: 80px; }

        #global-loader { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1d2e 0%, var(--primary-dark) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s; color:#fff;}
        .loader-logo { font-family: 'Prompt', sans-serif; font-size: 26px; font-weight: 700; margin-bottom: 15px; }
        .loader-bar { width: 220px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
        .loader-fill { height: 100%; width: 50%; background: var(--success); border-radius: 6px; animation: loadAnim 1.2s infinite ease-in-out; }
        @keyframes loadAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--text) 0%, var(--primary-dark) 100%); display: flex; align-items: center; justify-content: center; z-index: 9000; padding: 16px; }
        .login-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12); border-radius: 24px; padding: 40px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; text-align: center; font-size: 16px; }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-family: 'Prompt'; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s; }
        
        .nav { background: var(--nav-bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-inner { display: flex; align-items: center; padding: 0 10px; overflow-x: auto; max-width: 800px; margin: 0 auto; }
        .nav-tab { padding: 16px 12px; cursor: pointer; font-family: 'Prompt'; font-size: 14px; font-weight: 600; color: var(--nav-text); white-space: nowrap; transition: 0.3s; }
        .nav-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        
        .org-banner { background: var(--primary); color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-radius: 0 0 16px 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .org-logo { height: 40px; border-radius: 8px; object-fit: contain; }
        
        .sec { background: var(--surface); border-radius: var(--rs); padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); color: var(--board-text); }
        .sec-label { font-family: 'Prompt'; font-weight: 700; color: var(--primary); font-size: 15px; margin-bottom: 12px; border-bottom: 2px solid var(--border); padding-bottom: 8px; display: flex; align-items: center; gap: 8px;}
        
        /* Grid System Responsive */
        .fc { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fafbfe; margin-bottom: 10px; transition: 0.3s; color: var(--text); }
        .fc:focus { border-color: var(--primary); background: #fff; outline:none;}
        .frow { display: flex; gap: 12px; flex-wrap: wrap; }
        .fg { flex: 1; min-width: 120px; display: flex; flex-direction: column; }
        .fg label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); display: inline-block; box-shadow: 0 0 8px var(--success); }
        .status-dot.offline { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        .btn-export { background: #e0f2f1; color: #00695c; padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .avatar-wrapper { position: relative; cursor: pointer; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #eee; transition: 0.2s; }
        .avatar-wrapper:hover .avatar { opacity: 0.7; }
        .avatar-upload-icon { position: absolute; bottom: -2px; right: -2px; background: var(--primary); color: #fff; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }

        .btn-sm { padding: 8px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
        .tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
        .tbl th { text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 2px solid var(--border); color: var(--text); }
        .tbl td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        .expand-bar { background: linear-gradient(135deg, #f0f4ff 0%, #e2eafc 100%); border: 1px solid #d7e3fc; border-radius: 12px; padding: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .expand-icon { background: var(--primary); color: #fff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1a1d2e; color: #fff; padding: 14px 28px; border-radius: 30px; opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10000; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .tg-box { background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px; font-size:13px; }
        .tg-box label { display:flex; align-items:center; gap:8px; margin-bottom:5px; cursor:pointer; }
    </style>
</head>
<body>

<div id="global-loader"><div class="loader-logo">üè• Clinic Manager Pro</div><div class="loader-bar"><div class="loader-fill"></div></div></div>

<div id="login-screen">
    <div class="login-box">
        <img id="login-logo" src="" style="max-height:80px; margin-bottom:15px; display:none; border-radius:12px;">
        <div class="login-logo" id="login-title" style="font-family: 'Prompt'; font-size: 24px; color: #fff; font-weight: 700; margin-bottom: 5px;">Clinic Manager Pro</div>
        <div class="login-sub" style="color: #adb5bd; font-size: 14px; margin-bottom: 30px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        <input class="login-input" id="login-username" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
        <input class="login-input" id="login-pin" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PIN)" maxlength="10">
        <button class="login-btn" id="btn-login" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="login-err" style="color:var(--danger); font-size:14px; font-weight:600; margin-top:15px; min-height: 20px;"></div>
    </div>
</div>

<nav class="nav" id="main-nav" style="display:none">
    <div class="nav-inner">
        <div class="nav-tab active" id="tab-form" onclick="switchPage('form', this)">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="nav-tab" id="tab-appt" onclick="switchPage('appointments', this)">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
        <div class="nav-tab" id="tab-cust" onclick="switchPage('customers', this)">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-tab" id="tab-summary" onclick="switchPage('summary', this)">üìä ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="nav-tab" id="tab-settings" style="display:none;" onclick="switchPage('settings', this)">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <div class="avatar-wrapper" onclick="document.getElementById('my-avatar-upload').click()">
                <img id="nav-avatar" class="avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23ccc' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/></svg>">
                <div class="avatar-upload-icon">üì∑</div>
                <input type="file" id="my-avatar-upload" style="display:none;" accept="image/*" onchange="uploadOwnAvatar(this)">
            </div>
            <div>
                <div style="font-weight:700; color:var(--primary); font-size: 13px;" id="nav-display-name">User</div>
                <div style="font-size:10px; display:flex; align-items:center; gap:4px;">
                    <span class="status-dot" id="net-status"></span> <span id="net-text">Online</span>
                </div>
            </div>
            <button onclick="location.reload()" style="background:#fff2f2; color:var(--danger); border:none; padding:6px; border-radius:6px; cursor:pointer;">‡∏≠‡∏≠‡∏Å</button>
        </div>
    </div>
</nav>

<div id="main-content" style="display:none; padding: 0 15px; max-width: 800px; margin: 0 auto;">
    <div class="org-banner" id="ui-banner">
        <div style="display:flex; align-items:center; gap:15px;">
            <img id="ui-logo" class="org-logo" src="" style="display:none;">
            <div>
                <div class="org-name" id="ui-clinic-name" style="font-family: 'Prompt'; font-size: 18px; font-weight: 600;">Clinic System</div>
                <div style="font-size:12px; opacity:0.8;" id="ui-contact"></div>
            </div>
        </div>
    </div>

    <!-- ================== PAGE 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ================== -->
    <div id="page-form" class="page active">
        <div class="sec">
            <div class="sec-label">üë§ 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="frow" style="margin-bottom:10px;">
                <div class="fg" style="flex:3;"><input class="fc" id="f-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤..." type="tel"></div>
                <button class="login-btn" style="flex:1; padding:10px;" onclick="formSearchCustomer()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
            <div id="f-cust-info">
                <div class="frow"><div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á *</label><input class="fc" id="f-fn"></div><div class="fg"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fc" id="f-ln"></div></div>
                <div class="frow"><div class="fg"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label><input class="fc" id="f-ph" type="tel"></div><div class="fg"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label><input class="fc" id="f-em-ph" type="tel"></div></div>
                
                <div class="frow"><div class="fg"><label>ID Line</label><input class="fc" id="f-line"></div><div class="fg"><label>Facebook</label><input class="fc" id="f-fb"></div></div>

                <label style="font-size:13px; color:var(--success); font-weight:600; display:flex; gap:8px; align-items:center; margin-bottom:10px;"><input type="checkbox" id="f-pdpa" style="width:18px; height:18px;"> ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° PDPA</label>

                <div class="expand-bar" onclick="toggleExtra()"><div class="expand-icon" id="extra-icon">‚ûï</div><div class="expand-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (‡∏≠‡∏≤‡∏¢‡∏∏, ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å, ‡πÅ‡∏û‡πâ‡∏¢‡∏≤...)</div></div>
                <div id="extra-body" style="display:none; padding:15px; border:1px solid #e2eafc; border-top:none; border-radius:0 0 12px 12px;">
                    <div class="frow"><div class="fg"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input class="fc" id="f-age" type="number"></div><div class="fg"><label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input class="fc" id="f-weight" type="number"></div><div class="fg"><label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input class="fc" id="f-height" type="number"></div></div>
                    <div class="frow"><div class="fg"><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input class="fc" id="f-disease"></div><div class="fg"><label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input class="fc" id="f-allergy"></div></div>
                    <div class="frow"><div class="fg"><label>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</label><input class="fc" id="f-job"></div><div class="fg"><label>‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input class="fc" id="f-workplace"></div></div>
                    <div class="fg"><label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢</label><textarea class="fc" id="f-address" rows="2"></textarea></div>
                </div>
            </div>
        </div>

        <div class="sec" style="background:#f8f9fa;">
            <div class="sec-label">üéØ 2. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <select class="fc" id="f-trans-type" onchange="toggleFormSections()" style="font-weight:700; color:var(--primary);">
                <option value="new">üåü ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</option>
                <option value="old">‚è≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ / ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™</option>
            </select>
            <div id="f-old-order-sec" style="display:none; margin-top:10px;"><label style="font-size:12px; font-weight:700; color:var(--danger);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:</label><select class="fc" id="f-old-order-id"><option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option></select></div>
        </div>

        <div class="sec" id="f-items-sec">
            <div class="sec-label">üíâ 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ & ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)</div>
            <div id="item-list"></div>
            <button class="btn-sm" style="background:transparent; border:1px dashed var(--primary); color:var(--primary); width:100%; margin-top:5px; padding:12px;" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
            <div class="frow" style="margin-top:20px; align-items:flex-end;">
                <div class="fg"><label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ / ‡πÄ‡∏ã‡∏•‡∏•‡πå *</label><select class="fc" id="f-sale" style="font-weight:bold;"></select></div>
                <div class="fg"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input class="fc" id="f-total" type="text" readonly style="background:#eee; font-weight:700; color:var(--danger); font-size:18px;"></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-label">üí≥ 4. ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™</div>
            <div class="frow" style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:10px;"><div class="fg"><label>‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label><input class="fc" id="f-pay-amt" type="number"></div><div class="fg"><label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select class="fc" id="f-pay-method"><option>‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option><option>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option></select></div></div>
            <div style="border-top:1px dashed var(--border); padding-top:10px;"><label style="font-size:13px; font-weight:700; color:var(--primary);">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™)</label><input class="fc" id="f-usage-detail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1..."><div class="frow"><div class="fg"><label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label><select class="fc" id="f-dr"></select></div><div class="fg"><label>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢/BT</label><select class="fc" id="f-bt"></select></div></div></div>
        </div>

        <div class="sec">
            <div class="sec-label">üì∏ 5. ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / ‡∏™‡∏•‡∏¥‡∏õ</div>
            <div class="frow"><label class="btn-sm" style="background:#e2eafc; color:var(--primary-dark); text-align:center; flex:1; cursor:pointer;">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ<input type="file" id="f-photo-file" accept="image/*" style="display:none;" onchange="uploadToDrive(this)"></label><label class="btn-sm" style="background:#ffebee; color:#c62828; text-align:center; flex:1; cursor:pointer;">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ<input type="file" id="f-photo-cam" accept="image/*" capture="environment" style="display:none;" onchange="uploadToDrive(this)"></label></div>
            <div id="upload-status" style="margin-top:8px; font-size:12px; text-align:center; font-weight:600;"></div><input type="hidden" id="f-photo-url">
        </div>
        <button class="login-btn" id="btn-save" style="margin-bottom:20px; font-size:18px; padding:18px;" onclick="saveFullForm()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- ================== PAGE 2: ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ ================== -->
    <div id="page-appointments" class="page">
        <div class="sec" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="sec-label" style="margin:0;">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
            <div style="display:flex; gap:8px;">
                <button class="btn-export" onclick="exportCSV('appt-list-data', 'Appointments')">üì• Export</button>
                <button class="btn-sm" style="background:var(--primary); color:#fff;" onclick="openApptModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î</button>
            </div>
        </div>
        <div id="appt-list"><div style="text-align:center; color:var(--text2); padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        <table id="appt-list-data" style="display:none;"></table>
    </div>

    <!-- ================== PAGE 3: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ================== -->
    <div id="page-customers" class="page">
        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="sec-label" style="margin:0;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                <button class="btn-export" onclick="exportCSV('cust-table-data', 'Customers')">üì• Export</button>
            </div>
            <input class="fc" id="cust-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." oninput="searchCustomer()">
            <div id="cust-results" style="margin-top:10px;"></div>
        </div>
        <div id="cust-detail-area"></div>
        <table id="cust-table-data" style="display:none;"></table>
    </div>
    
    <!-- ================== PAGE 4: ‡∏™‡∏£‡∏∏‡∏õ ================== -->
    <div id="page-summary" class="page">
        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="sec-label" style="margin:0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ & ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô</div>
                <button class="btn-export" onclick="exportCSV('sum-table', 'Summary')">üì• Export</button>
            </div>
            
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:600; color:var(--text2);">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <div class="frow">
                    <div class="fg"><input type="date" class="fc" id="sum-start"></div>
                    <div class="fg"><input type="date" class="fc" id="sum-end"></div>
                    <button class="btn-sm" style="background:var(--primary); color:#fff; height:42px;" onclick="loadSummary()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>

            <div id="sum-shop-area" style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:#e3f2fd; padding:15px; border-radius:12px; text-align:center;"><div style="font-size:12px; color:#1565c0;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)</div><div style="font-size:20px; font-weight:700; color:#0d47a1;" id="sum-shop-sales">0</div></div>
                <div style="flex:1; background:#e8f5e9; padding:15px; border-radius:12px; text-align:center;"><div style="font-size:12px; color:#2e7d32;">‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏±‡∏Å % ‡∏ö‡∏±‡∏ï‡∏£)</div><div style="font-size:20px; font-weight:700; color:#1b5e20;" id="sum-shop-paid">0</div></div>
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th style="text-align:right;">‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á</th><th style="text-align:right;">‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô / ‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠(BT)</th></tr></thead>
                    <tbody id="sum-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ================== PAGE 5: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ================== -->
    <div id="page-settings" class="page">
        
        <div class="sec" style="border-left: 4px solid var(--accent);">
            <div class="sec-label">üé® ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ UI & ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</div>
            <div class="frow">
                <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><input class="fc" id="set-ui-name"></div>
                <div class="fg"><label>‡∏´‡∏±‡∏Å % ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label><input class="fc" id="set-ui-ccfee" type="number"></div>
            </div>
            <div class="frow">
                <div class="fg"><label>‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏∏‡πà‡∏°</label><input type="color" class="fc" id="set-ui-primary" style="height:40px; padding:0;"></div>
                <div class="fg"><label>‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö</label><input type="color" class="fc" id="set-ui-bg" style="height:40px; padding:0;"></div>
                <div class="fg"><label>‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô</label><input type="color" class="fc" id="set-ui-board-text" style="height:40px; padding:0;"></div>
            </div>
            <div class="frow">
                <div class="fg"><label>‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π (Nav)</label><input type="color" class="fc" id="set-ui-nav-bg" style="height:40px; padding:0;"></div>
                <div class="fg"><label>‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π</label><input type="color" class="fc" id="set-ui-nav-text" style="height:40px; padding:0;"></div>
            </div>
            <div class="frow">
                <div class="fg"><label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><input class="fc" id="set-ui-contact"></div>
                <div class="fg"><label>‡πÇ‡∏•‡πÇ‡∏Å‡πâ</label><input type="file" class="fc" accept="image/*" onchange="uploadLogo(this)"><input type="hidden" id="set-ui-logo"></div>
            </div>
        </div>

        <div class="sec" style="border-left: 4px solid var(--primary-dark);">
            <div class="sec-label">ü§ñ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
            <div class="frow"><div class="fg"><label>Bot Token</label><input class="fc" id="set-tg-token"></div><div class="fg"><label>Chat ID</label><input class="fc" id="set-tg-chatid"></div></div>
            
            <div class="frow" style="margin-bottom:10px;">
                <div class="fg tg-box">
                    <label style="color:var(--primary); font-weight:700; margin-bottom:8px;">üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (Events)</label>
                    <label><input type="checkbox" id="tg-ev-new" checked> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</label>
                    <label><input type="checkbox" id="tg-ev-usage"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥ / ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™</label>
                </div>
                <div class="fg tg-box">
                    <label style="color:var(--primary); font-weight:700; margin-bottom:8px;">üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á</label>
                    <label><input type="checkbox" id="tg-fd-date" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <label><input type="checkbox" id="tg-fd-name" checked> ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <label><input type="checkbox" id="tg-fd-amt" checked> ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</label>
                    <label><input type="checkbox" id="tg-fd-staff" checked> ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                </div>
            </div>
            <button class="login-btn" style="padding:10px; font-size:14px;" onclick="saveUISettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="sec" style="border-left: 4px solid var(--success);">
            <div class="sec-label">üì¶ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà & ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="frow" style="margin-bottom:10px;"><div class="fg"><input class="fc" id="set-cat-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"></div><div class="fg" style="flex:0.5"><input class="fc" id="set-cat-pct" type="number" placeholder="% ‡∏ó‡∏∏‡∏ô"></div><button class="btn-sm" style="background:var(--success); color:#fff;" onclick="addCatalog('category')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
            <div class="frow" style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div class="fg"><select class="fc" id="set-prod-cat"></select></div>
                <div class="fg"><input class="fc" id="set-prod-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"></div>
                <div class="fg" style="flex:0.5"><input class="fc" id="set-prod-unit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"></div>
                <div class="fg" style="flex:0.5"><input class="fc" id="set-prod-btfee" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠ BT"></div>
                <button class="btn-sm" style="background:var(--primary); color:#fff;" onclick="addCatalog('product')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
        </div>
        
        <div class="sec" style="border-left: 4px solid var(--warning);">
            <div class="sec-label">üìà ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå</div>
            <div class="frow"><div class="fg"><input class="fc" id="set-tier-min" type="number" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°"></div><div class="fg"><input class="fc" id="set-tier-max" type="number" placeholder="‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏î(‡∏ß‡πà‡∏≤‡∏á=unlimit)"></div><div class="fg"><input class="fc" id="set-tier-pct" type="number" placeholder="% ‡∏Ñ‡∏≠‡∏°"></div><button class="btn-sm" style="background:var(--warning);" onclick="addCatalog('tier')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
        </div>

        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><div class="sec-label" style="margin:0;">üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div><button class="btn-sm" style="background:var(--primary); color:#fff;" onclick="document.getElementById('modal-staff').style.display='flex'">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
            <table class="tbl"><tbody id="staff-table"></tbody></table>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-appt" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:400px; padding:20px; border-radius:12px;">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h3><input class="fc" id="apt-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
        <div class="frow"><div class="fg"><input class="fc" id="apt-fn" placeholder="‡∏ä‡∏∑‡πà‡∏≠"></div><div class="fg"><input class="fc" id="apt-ln" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div></div>
        <div class="frow"><div class="fg"><input type="date" class="fc" id="apt-date"></div><div class="fg"><input type="time" class="fc" id="apt-time"></div></div>
        <textarea class="fc" id="apt-detail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
        <div class="frow"><div class="fg"><select class="fc" id="apt-dr"></select></div><div class="fg"><select class="fc" id="apt-bt"></select></div></div>
        <div style="display:flex; gap:10px;"><button class="login-btn" style="background:#ddd; color:#000;" onclick="document.getElementById('modal-appt').style.display='none'">‡∏õ‡∏¥‡∏î</button><button class="login-btn" onclick="saveAppointment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
</div>
<div id="modal-staff" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:350px; padding:20px; border-radius:12px;">
        <h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3><input class="fc" id="stf-user" placeholder="Username"><input class="fc" id="stf-pin" placeholder="PIN" maxlength="4" type="tel"><input class="fc" id="stf-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å">
        <select class="fc" id="stf-role"><option value="Sales">Sales (‡πÄ‡∏ã‡∏•‡∏•‡πå)</option><option value="BT">BT</option><option value="Dr">Dr</option><option value="Front">Front</option><option value="Manager">Manager</option><option value="Admin">Admin</option></select>
        <div style="display:flex; gap:10px;"><button class="login-btn" style="background:#ddd; color:#000;" onclick="document.getElementById('modal-staff').style.display='none'">‡∏õ‡∏¥‡∏î</button><button class="login-btn" onclick="addStaff()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
</div>
<div id="toast">‚úÖ ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

<script>
    let currentUser = null, staffList = [], catalog = { categories: [], products: [], tiers: [] }, systemSettings = {};
    const fxCash = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
    const fxErr = new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3');
    
    window.addEventListener('online', updateStatus); window.addEventListener('offline', updateStatus);
    function updateStatus() { const d = document.getElementById('net-status'); const t = document.getElementById('net-text'); if(navigator.onLine){d.classList.remove('offline'); t.textContent='Online';} else {d.classList.add('offline'); t.textContent='Offline'; fxErr.play();} }

    window.onload = async () => {
        updateStatus();
        setTimeout(() => { document.getElementById('global-loader').style.opacity = '0'; setTimeout(()=>document.getElementById('global-loader').style.display='none', 500); }, 800);
        
        const d = new Date(); document.getElementById('sum-end').value = d.toISOString().split('T')[0];
        d.setDate(1); document.getElementById('sum-start').value = d.toISOString().split('T')[0];
        
        try { const res = await apiCall('get_settings', {}); if(res.success && res.settings) applyTheme(res.settings); } catch(e) {}
    };

    async function apiCall(action, payload) {
        if(!navigator.onLine) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', true); fxErr.play(); return {success:false}; }
        try { const res = await fetch('/.netlify/functions/api', { method: 'POST', body: JSON.stringify({ action, payload }) }); return await res.json(); } 
        catch (e) { return { success: false, message: 'Connection Error' }; }
    }

    async function doLogin() {
        const res = await apiCall('login', { username: document.getElementById('login-username').value, pin: document.getElementById('login-pin').value });
        if (res.success) {
            currentUser = res.user; document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'block'; document.getElementById('main-content').style.display = 'block';
            document.getElementById('nav-display-name').textContent = currentUser.display_name;
            if(currentUser.avatar_url) document.getElementById('nav-avatar').src = currentUser.avatar_url;
            await initSystem(); showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö');
        } else { fxErr.play(); document.getElementById('login-err').textContent = res.message; }
    }

    async function initSystem() {
        const setRes = await apiCall('get_settings', {});
        if(setRes.success && setRes.settings) applyTheme(setRes.settings);

        const res = await apiCall('get_staff', {}); if (res.success) { staffList = res.staff; renderSelects(); }
        const catRes = await apiCall('get_catalog', {}); 
        if(catRes.success) { 
            catalog = catRes; 
            document.getElementById('set-prod-cat').innerHTML = catalog.categories.map(c=>`<option value="${c.id}">${c.category_name} (‡∏´‡∏±‡∏Å ${parseFloat(c.deduct_cost_percent)}%)</option>`).join('');
        }
        
        const role = currentUser.role;
        // Role Logic: 
        // 1. ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Owner ‡πÅ‡∏•‡∏∞ Admin ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)
        if (!['Owner', 'Admin'].includes(role)) {
            document.getElementById('tab-settings').style.display = 'none';
        } else {
            loadAllStaff();
        }

        // 2. ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Ops Staff) ‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô
        if(['Sales', 'BT', 'Dr'].includes(role)) {
            const s = document.getElementById('f-sale'); s.value = currentUser.id; s.disabled = true; s.style.background = '#eee';
            document.getElementById('sum-shop-area').style.display = 'none';
        }
        
        addItemRow(); loadAppointments();
    }

    function applyTheme(s) {
        systemSettings = s;
        const root = document.documentElement;
        if(s.ui_primary_color) { root.style.setProperty('--primary', s.ui_primary_color); root.style.setProperty('--primary-dark', s.ui_primary_color); document.getElementById('set-ui-primary').value = s.ui_primary_color;}
        if(s.ui_bg_color) { root.style.setProperty('--bg', s.ui_bg_color); document.getElementById('set-ui-bg').value = s.ui_bg_color; }
        if(s.ui_nav_bg) { root.style.setProperty('--nav-bg', s.ui_nav_bg); document.getElementById('set-ui-nav-bg').value = s.ui_nav_bg; }
        if(s.ui_nav_text) { root.style.setProperty('--nav-text', s.ui_nav_text); document.getElementById('set-ui-nav-text').value = s.ui_nav_text; }
        if(s.ui_board_text) { root.style.setProperty('--board-text', s.ui_board_text); document.getElementById('set-ui-board-text').value = s.ui_board_text; }
        
        if(s.clinic_name) { document.getElementById('ui-clinic-name').textContent = s.clinic_name; document.getElementById('login-title').textContent = s.clinic_name; document.getElementById('set-ui-name').value = s.clinic_name;}
        if(s.contact_info) { document.getElementById('ui-contact').textContent = s.contact_info; document.getElementById('set-ui-contact').value = s.contact_info;}
        if(s.logo_url) { document.querySelectorAll('.org-logo, #login-logo').forEach(l => { l.src = s.logo_url; l.style.display = 'block'; }); document.getElementById('set-ui-logo').value = s.logo_url; }
        if(s.cc_fee_percent) document.getElementById('set-ui-ccfee').value = s.cc_fee_percent;
        
        if(s.tg_token) document.getElementById('set-tg-token').value = s.tg_token;
        if(s.tg_chat_id) document.getElementById('set-tg-chatid').value = s.tg_chat_id;
        if(s.tg_config) {
            let tc = typeof s.tg_config === 'string' ? JSON.parse(s.tg_config) : s.tg_config;
            if(tc.events) { document.getElementById('tg-ev-new').checked = tc.events.new_order; document.getElementById('tg-ev-usage').checked = tc.events.usage; }
            if(tc.fields) { document.getElementById('tg-fd-date').checked = tc.fields.date; document.getElementById('tg-fd-name').checked = tc.fields.name; document.getElementById('tg-fd-amt').checked = tc.fields.amount; document.getElementById('tg-fd-staff').checked = tc.fields.staff; }
        }
    }

    function renderSelects() {
        document.getElementById('f-sale').innerHTML = '<option value="">-‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå-</option>' + staffList.filter(s=>['Sales','Manager','Owner','Admin', 'Front'].includes(s.role)).map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('f-dr').innerHTML = '<option value="">-‡πÅ‡∏û‡∏ó‡∏¢‡πå-</option>' + staffList.filter(s=>s.role==='Dr').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('f-bt').innerHTML = '<option value="">-BT-</option>' + staffList.filter(s=>s.role==='BT').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('apt-dr').innerHTML = document.getElementById('f-dr').innerHTML;
        document.getElementById('apt-bt').innerHTML = document.getElementById('f-bt').innerHTML;
    }

    function toggleExtra() { const b = document.getElementById('extra-body'); const i = document.getElementById('extra-icon'); const isShow = b.style.display === 'block'; b.style.display = isShow ? 'none' : 'block'; i.textContent = isShow ? '‚ûï' : '‚ûñ'; }
    function toggleFormSections() { const t = document.getElementById('f-trans-type').value; if(t === 'new') { document.getElementById('f-items-sec').style.display='block'; document.getElementById('f-old-order-sec').style.display='none'; } else { document.getElementById('f-items-sec').style.display='none'; document.getElementById('f-old-order-sec').style.display='block'; } }

    async function formSearchCustomer() {
        const p = document.getElementById('f-search').value; if(!p) return;
        const res = await apiCall('search_customers', {query: p, userRole: currentUser.role, userId: currentUser.id});
        if(res.success && res.customers.length > 0) {
            const c = res.customers[0];
            ['fn','ln','ph','em-ph','line','fb','age','weight','height','disease','allergy','job','workplace','address'].forEach(k => {
                const map = {fn:'first_name',ln:'last_name',ph:'phone','em-ph':'emergency_phone', line:'line_id', fb:'facebook', allergy:'drug_allergy', job:'occupation'};
                if(document.getElementById(`f-${k}`)) document.getElementById(`f-${k}`).value = c[map[k]||k] || '';
            });
            showToast('‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥');
            const dRes = await apiCall('get_customer_full_detail', {customerId: c.id});
            if(dRes.success) {
                document.getElementById('f-old-order-id').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå --</option>' + dRes.orders.map(o => {
                    const paid = dRes.payments.filter(p=>p.order_id===o.id).reduce((s,p)=>s+parseFloat(p.amount),0);
                    return `<option value="${o.id}">${new Date(o.created_at).toLocaleDateString()} (‡∏Ñ‡πâ‡∏≤‡∏á ${(o.total_price-paid).toLocaleString()}‡∏ø)</option>`;
                }).join('');
            }
        } else { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', true); fxErr.play(); }
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Card Layout Responsive 100%) ---
    function addItemRow() {
        const div = document.createElement('div'); 
        div.className = 'item-wrapper';
        div.style.cssText = 'background:var(--surface); border:1px solid var(--border); padding:15px; border-radius:12px; margin-bottom:12px; position:relative; box-shadow:0 2px 5px rgba(0,0,0,0.02);';
        
        let prodOpts = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö --</option>';
        catalog.products.forEach(p => { 
            prodOpts += `<option value="${p.id}" data-name="${p.product_name}" data-unit="${p.unit_name||''}" data-pct="${catalog.categories.find(c=>c.id===p.category_id)?.deduct_cost_percent||0}" data-bt="${p.bt_fee||0}">${p.product_name}</option>`; 
        });

        div.innerHTML = `
            <button onclick="this.parentElement.remove(); calcTotal()" style="position:absolute; top:15px; right:15px; color:var(--danger); background:#ffebee; border:none; width:28px; height:28px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">‚úï</button>
            
            <div class="frow" style="margin-bottom:10px; padding-right:30px;">
                <div class="fg" style="flex:1.5; min-width:160px;">
                    <label style="color:var(--primary);">1. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select class="fc item-select" onchange="autoFillItem(this)" style="margin-bottom:0;">${prodOpts}</select>
                    <input type="hidden" class="item-name"><input type="hidden" class="item-pct"><input type="hidden" class="item-btfee">
                </div>
                <div class="fg" style="flex:2; min-width:200px;">
                    <label>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏£‡∏á‡∏õ‡∏≤‡∏Å)</label>
                    <input class="fc item-note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" style="margin-bottom:0;">
                </div>
            </div>
            
            <div class="frow" style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div class="fg" style="flex:1; min-width:70px;"><label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label><input class="fc item-vol" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100" style="margin-bottom:0;"></div>
                <div class="fg" style="flex:1; min-width:70px;"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input class="fc item-unit" placeholder="Unit, cc" style="margin-bottom:0;"></div>
                <div class="fg" style="flex:1; min-width:70px;"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</label><input class="fc item-qty" type="number" value="1" min="1" oninput="calcTotal()" style="margin-bottom:0;"></div>
                <div class="fg" style="flex:1.5; min-width:100px;"><label>‡∏£‡∏≤‡∏Ñ‡∏≤</label><input class="fc item-price" type="number" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" oninput="calcTotal()" style="margin-bottom:0;"></div>
                <div class="fg" style="flex:1.5; min-width:100px;"><label style="color:var(--danger);">‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label><input class="fc item-total" type="number" readonly style="background:#fff; color:var(--danger); font-weight:bold; margin-bottom:0; border-color:var(--danger);"></div>
            </div>`;
        document.getElementById('item-list').appendChild(div);
    }
    
    function autoFillItem(sel) { 
        const opt = sel.options[sel.selectedIndex]; 
        const row = sel.closest('.item-wrapper'); 
        if(opt.value) { 
            row.querySelector('.item-name').value = opt.getAttribute('data-name'); 
            const defaultUnit = opt.getAttribute('data-unit');
            if(defaultUnit) row.querySelector('.item-unit').value = defaultUnit;
            row.querySelector('.item-pct').value = opt.getAttribute('data-pct'); 
            row.querySelector('.item-btfee').value = opt.getAttribute('data-bt'); 
            calcTotal(); 
        } 
    }
    
    function calcTotal() { 
        let sum = 0; 
        document.querySelectorAll('.item-wrapper').forEach(r => { 
            const q = parseFloat(r.querySelector('.item-qty').value||0); 
            const p = parseFloat(r.querySelector('.item-price').value||0); 
            const t = q*p; 
            r.querySelector('.item-total').value = t > 0 ? t : ''; 
            sum += t; 
        }); 
        document.getElementById('f-total').value = sum.toLocaleString(); 
        return sum; 
    }

    async function saveFullForm() {
        const btn = document.getElementById('btn-save'); btn.disabled = true; const t = document.getElementById('f-trans-type').value;
        const payload = {
            firstName: document.getElementById('f-fn').value, lastName: document.getElementById('f-ln').value, phone: document.getElementById('f-ph').value, emergencyPhone: document.getElementById('f-em-ph').value,
            lineId: document.getElementById('f-line').value, facebook: document.getElementById('f-fb').value,
            age: document.getElementById('f-age').value, weight: document.getElementById('f-weight').value, height: document.getElementById('f-height').value, disease: document.getElementById('f-disease').value, drugAllergy: document.getElementById('f-allergy').value, occupation: document.getElementById('f-job').value, workplace: document.getElementById('f-workplace').value, address: document.getElementById('f-address').value, pdpa: document.getElementById('f-pdpa').checked,
            existingOrderId: t === 'old' ? document.getElementById('f-old-order-id').value : null, items: [], totalPrice: 0, saleStaffId: document.getElementById('f-sale').value, saleStaffName: document.getElementById('f-sale').selectedOptions[0]?.text,
            paymentAmount: parseFloat(document.getElementById('f-pay-amt').value || 0), paymentMethod: document.getElementById('f-pay-method').value, usageDetails: document.getElementById('f-usage-detail').value, drId: document.getElementById('f-dr').value, btId: document.getElementById('f-bt').value, imageUrl: document.getElementById('f-photo-url').value, currentUserId: currentUser.id
        };

        if(t === 'new') {
            document.querySelectorAll('.item-wrapper').forEach(r => { 
                const name = r.querySelector('.item-name').value; 
                const note = r.querySelector('.item-note').value;
                const vol = r.querySelector('.item-vol').value;
                const unit = r.querySelector('.item-unit').value;
                const qty = parseFloat(r.querySelector('.item-qty').value||0); 
                const price = parseFloat(r.querySelector('.item-price').value||0); 
                if(name && qty>0 && price>=0) {
                    payload.items.push({ 
                        name: name, note: note, volume: vol, unit: unit, 
                        qty: qty, price: price, total: qty*price, 
                        deduct_percent: parseFloat(r.querySelector('.item-pct').value||0),
                        bt_fee: parseFloat(r.querySelector('.item-btfee').value||0)
                    });
                }
            });
            payload.totalPrice = calcTotal(); 
            if(!payload.saleStaffId || payload.items.length===0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', true); fxErr.play(); btn.disabled=false; return; }
        } else { 
            if(!payload.existingOrderId) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true); fxErr.play(); btn.disabled=false; return; } 
        }

        const res = await apiCall('save_order', payload);
        if (res.success) { if(typeof confetti !== 'undefined') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }}); fxCash.play(); showToast('üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); setTimeout(() => location.reload(), 2500); } 
        else { showToast('Error', true); fxErr.play(); btn.disabled = false; }
    }

    // --- SUMMARY & APPTS ---
    async function loadSummary() {
        const res = await apiCall('get_sales_summary', { startDate: document.getElementById('sum-start').value, endDate: document.getElementById('sum-end').value, userRole: currentUser.role, userId: currentUser.id });
        if(res.success) {
            document.getElementById('sum-shop-sales').textContent = res.shopSummary.totalSales.toLocaleString(); document.getElementById('sum-shop-paid').textContent = res.shopSummary.totalCollected.toLocaleString();
            document.getElementById('sum-table').innerHTML = res.staffPerf.map(s => `<tr><td><div style="font-weight:700;">${s.name}</div></td><td style="text-align:right;">${parseFloat(s.total_sales).toLocaleString()}</td><td style="text-align:right; color:var(--success);">${parseFloat(s.total_collected).toLocaleString()}</td><td style="text-align:right; color:var(--primary); font-weight:700;">${parseFloat(s.commission_amount).toLocaleString()} <span style="font-size:10px;">(${s.commission_percent}%)</span><br><span style="font-size:11px; color:#f57c00;">‡∏Ñ‡πà‡∏≤‡∏°‡∏∑‡∏≠: ${parseFloat(s.bt_fee_total||0).toLocaleString()} ‡∏ø</span></td></tr>`).join('');
        }
    }

    async function loadAppointments() {
        const res = await apiCall('get_appointments', {});
        if(res.success) {
            let html = ''; let tableData = '<tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏´‡∏°‡∏≠/BT</th></tr>';
            res.appointments.forEach(a => {
                const canSeeDebt = ['Owner','Admin','Manager','Front'].includes(currentUser.role) || a.created_by === currentUser.id || a.dr_id === currentUser.id || a.bt_id === currentUser.id;
                html += `<div style="background:var(--surface); border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:8px; border-left:4px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between; font-weight:700;"><span>‚è∞ ${a.appointment_time.substring(0,5)} | ${new Date(a.appointment_date).toLocaleDateString('th-TH')}</span></div>
                    <div>üë§ ${a.first_name} ${a.last_name||''} üìû <a href="tel:${a.phone}">${a.phone}</a></div>
                    <div style="font-size:12px; color:var(--text2);">üìã ${a.service_details||'-'} | üë®‚Äç‚öïÔ∏è ${a.dr_name||'-'} üíÜ‚Äç‚ôÄÔ∏è ${a.bt_name||'-'}</div>
                    ${canSeeDebt ? `<button class="btn-sm" style="width:100%; margin-top:5px; background:#f0f4ff;" onclick="toggleHistory(${a.id}, ${a.customer_id})">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</button><div id="hist-${a.id}" style="display:none; margin-top:5px; font-size:12px;"></div>` : ''}
                </div>`;
                tableData += `<tr><td>${a.appointment_date}</td><td>${a.appointment_time}</td><td>${a.first_name} ${a.last_name||''}</td><td>${a.phone}</td><td>${a.service_details}</td><td>${a.dr_name||''} ${a.bt_name||''}</td></tr>`;
            });
            document.getElementById('appt-list').innerHTML = html || '<div style="text-align:center; color:var(--text2); padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>';
            document.getElementById('appt-list-data').innerHTML = tableData;
        }
    }
    
    async function toggleHistory(apptId, customerId) {
        const p = document.getElementById(`hist-${apptId}`); if(p.style.display === 'block') { p.style.display = 'none'; return; } p.style.display = 'block'; p.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        const res = await apiCall('get_customer_full_detail', { customerId });
        if(res.success) p.innerHTML = `<div style="color:var(--danger); font-weight:700;">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°: ${parseFloat(res.total_debt).toLocaleString()}‡∏ø</div>`;
    }

    async function searchCustomer() {
        const q = document.getElementById('cust-search').value; if(q.length < 2) return;
        const res = await apiCall('search_customers', { query: q, userRole: currentUser.role, userId: currentUser.id });
        if(res.success) {
            document.getElementById('cust-results').innerHTML = res.customers.map(c => `<div style="background:var(--surface); border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:8px; cursor:pointer;" onclick="loadCustomerDetail(${c.id})"><div style="font-weight:700;">${c.first_name} ${c.last_name||''}</div><div style="font-size:12px;">üìû ${c.phone}</div></div>`).join('');
            let tData = '<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>Line</th></tr>' + res.customers.map(c=>`<tr><td>${c.first_name} ${c.last_name||''}</td><td>${c.phone}</td><td>${c.line_id||''}</td></tr>`).join('');
            document.getElementById('cust-table-data').innerHTML = tData;
        }
    }
    
    async function loadCustomerDetail(cid) {
        const res = await apiCall('get_customer_full_detail', { customerId: cid }); if(!res.success) return;
        document.getElementById('cust-results').innerHTML = '';
        const html = `<div style="background:var(--surface); padding:20px; border-radius:12px; border:1px solid var(--primary); margin-top:10px;">
            <h3 style="color:var(--primary); margin-bottom:5px;">${res.customer.first_name} ${res.customer.last_name||''}</h3>
            <div style="margin-bottom:10px;">üìû ${res.customer.phone} ${res.customer.line_id ? '| Line: '+res.customer.line_id : ''}</div>
            <div style="color:var(--danger); font-weight:700; padding:5px; background:#ffebee; border-radius:6px; display:inline-block;">‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: ${parseFloat(res.total_debt).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            <div class="sec-label" style="margin-top:15px;">üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•</div>
            ${res.orders.map(o => { const paid = res.payments.filter(p=>p.order_id===o.id).reduce((s,p)=>s+parseFloat(p.amount),0); return `<div style="border-bottom:1px dashed #ccc; padding:5px 0; font-size:12px;"><div>üìÖ ${new Date(o.created_at).toLocaleDateString()} | ‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢ ${o.sale_name||'-'}</div><div>‡∏¢‡∏≠‡∏î ${parseFloat(o.total_price).toLocaleString()} (‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${paid.toLocaleString()} | ‡∏Ñ‡πâ‡∏≤‡∏á ${(o.total_price-paid).toLocaleString()})</div></div>`; }).join('') || '<div style="font-size:12px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'}
        </div>`;
        document.getElementById('cust-detail-area').innerHTML = html;
    }

    // --- SETTINGS ---
    async function saveUISettings() {
        const p = {
            action: 'save_settings',
            clinic_name: document.getElementById('set-ui-name').value, ui_primary_color: document.getElementById('set-ui-primary').value, ui_bg_color: document.getElementById('set-ui-bg').value, ui_nav_bg: document.getElementById('set-ui-nav-bg').value, ui_nav_text: document.getElementById('set-ui-nav-text').value, ui_board_text: document.getElementById('set-ui-board-text').value, contact_info: document.getElementById('set-ui-contact').value, logo_url: document.getElementById('set-ui-logo').value, cc_fee_percent: document.getElementById('set-ui-ccfee').value,
            tg_token: document.getElementById('set-tg-token').value, tg_chat_id: document.getElementById('set-tg-chatid').value,
            tg_config: { events: { new_order: document.getElementById('tg-ev-new').checked, usage: document.getElementById('tg-ev-usage').checked }, fields: { date: document.getElementById('tg-fd-date').checked, name: document.getElementById('tg-fd-name').checked, amount: document.getElementById('tg-fd-amt').checked, staff: document.getElementById('tg-fd-staff').checked } }
        };
        const res = await apiCall('save_settings', p); if(res.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); applyTheme(p); }
    }

    async function addCatalog(type) {
        let p = { type };
        if(type==='category') { p.name = document.getElementById('set-cat-name').value; p.percent = document.getElementById('set-cat-pct').value; }
        if(type==='product') { p.categoryId = document.getElementById('set-prod-cat').value; p.name = document.getElementById('set-prod-name').value; p.unit = document.getElementById('set-prod-unit').value; p.bt_fee = document.getElementById('set-prod-btfee').value;}
        if(type==='tier') { p.min = document.getElementById('set-tier-min').value; p.max = document.getElementById('set-tier-max').value; p.percent = document.getElementById('set-tier-pct').value; }
        const res = await apiCall('manage_catalog', p); if(res.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); setTimeout(()=>location.reload(), 1000); }
    }

    async function uploadToDrive(input) {
        const file = input.files[0]; if(!file) return; document.getElementById('upload-status').textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Img_${Date.now()}.jpg` });
            if(res.success) { document.getElementById('f-photo-url').value = res.link; document.getElementById('upload-status').innerHTML='<span style="color:green;">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>'; } else { document.getElementById('upload-status').innerHTML='<span style="color:red;">‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>'; fxErr.play(); }
        }; r.readAsDataURL(file);
    }
    
    async function uploadOwnAvatar(input) {
        const file = input.files[0]; if(!file) return; showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...');
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Avatar_${currentUser.id}_${Date.now()}.jpg` });
            if(res.success) { await apiCall('update_own_avatar', { userId: currentUser.id, avatar_url: res.link }); document.getElementById('nav-avatar').src = res.link; showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        }; r.readAsDataURL(file);
    }
    
    async function uploadLogo(input) { const file = input.files[0]; if(!file) return; showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...'); const r = new FileReader(); r.onload = async(e) => { const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Logo_${Date.now()}.png` }); if(res.success) { document.getElementById('set-ui-logo').value = res.link; showToast('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }; r.readAsDataURL(file); }
    async function loadAllStaff() { const res = await apiCall('get_staff', {}); if(res.success) { document.getElementById('staff-table').innerHTML = res.staff.map(u => `<tr><td>${u.display_name} <div style="font-size:11px; color:var(--text2);">${u.role}</div></td><td><button class="btn-sm" style="color:red;" onclick="delStaff(${u.id})">‡∏•‡∏ö</button></td></tr>`).join(''); } }
    async function addStaff() { const res = await apiCall('manage_staff', { subAction: 'add', username: document.getElementById('stf-user').value, pin: document.getElementById('stf-pin').value, name: document.getElementById('stf-name').value, role: document.getElementById('stf-role').value }); if(res.success) { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); document.getElementById('modal-staff').style.display='none'; loadAllStaff(); } }
    async function delStaff(id) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?')) { await apiCall('manage_staff', { subAction: 'delete', id }); loadAllStaff(); } }
    function openApptModal() { document.getElementById('modal-appt').style.display='flex'; }
    async function saveAppointment() { const res = await apiCall('save_appointment', { firstName: document.getElementById('apt-fn').value, lastName: document.getElementById('apt-ln').value, phone: document.getElementById('apt-phone').value, date: document.getElementById('apt-date').value, time: document.getElementById('apt-time').value, details: document.getElementById('apt-detail').value, drId: document.getElementById('apt-dr').value, btId: document.getElementById('apt-bt').value, currentUserId: currentUser.id }); if(res.success) { showToast('‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); document.getElementById('modal-appt').style.display='none'; loadAppointments(); } }

    function switchPage(p, el) { document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); el.classList.add('active'); }
    function showToast(m, err=false) { const t = document.getElementById('toast'); t.textContent=m; t.style.background=err?'var(--danger)':'var(--board-text)'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    function exportCSV(tid, fn) { 
        let csv = []; let rows = document.querySelectorAll(`#${tid} tr`); 
        if(rows.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export', true); fxErr.play(); return; }
        for (let i=0; i<rows.length; i++) { let row = [], cols = rows[i].querySelectorAll("td, th"); for (let j=0; j<cols.length; j++) row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"'); csv.push(row.join(",")); }
        let blob = new Blob(["\ufeff"+csv.join("\n")], {type: "text/csv;charset=utf-8;"}); let link = document.createElement("a"); link.download = fn+'.csv'; link.href = window.URL.createObjectURL(blob); link.style.display = "none"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
</script>
</body>
</html>
