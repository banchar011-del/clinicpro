<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinic Manager Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö */
        :root { 
            --primary: #4361ee; --primary-dark: #2d47c9; 
            --success: #06d6a0; --warning: #ffd166; --danger: #ef476f; 
            --bg: #f4f6fb; --surface: #ffffff; 
            --text: #1a1d2e; --text2: #6c757d; --border: #e2e6f0; --rs: 12px; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 80px; transition: background 0.3s; }

        /* LOADER & LOGIN */
        #global-loader { position: fixed; inset: 0; background: var(--primary-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s; color:#fff;}
        
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--text) 0%, var(--primary-dark) 100%); display: flex; align-items: center; justify-content: center; z-index: 9000; padding: 16px; }
        .login-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12); border-radius: 24px; padding: 40px; width: 100%; max-width: 380px; text-align: center; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; text-align: center; font-size: 16px; }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: #fff; font-family: 'Prompt'; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s; }
        
        /* UI COMPONENTS */
        .nav { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-inner { display: flex; align-items: center; padding: 0 10px; overflow-x: auto; max-width: 800px; margin: 0 auto; }
        .nav-tab { padding: 16px 12px; cursor: pointer; font-family: 'Prompt'; font-size: 14px; font-weight: 600; color: var(--text2); white-space: nowrap; }
        .nav-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        
        .org-banner { background: var(--primary); color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-radius: 0 0 16px 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: background 0.3s; }
        .org-logo { height: 40px; border-radius: 8px; object-fit: contain; }
        
        .sec { background: var(--surface); border-radius: var(--rs); padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .sec-label { font-family: 'Prompt'; font-weight: 700; color: var(--primary); font-size: 15px; margin-bottom: 12px; border-bottom: 2px solid var(--border); padding-bottom: 8px; display: flex; align-items: center; gap: 8px;}
        .fc { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fafbfe; margin-bottom: 10px; }
        .frow { display: flex; gap: 12px; flex-wrap: wrap; }
        .fg { flex: 1; min-width: 120px; display: flex; flex-direction: column; }
        .fg label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; }
        
        /* CONNECTION STATUS */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); display: inline-block; box-shadow: 0 0 8px var(--success); }
        .status-dot.offline { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        
        /* EXPORT BUTTON */
        .btn-export { background: #e0f2f1; color: #00695c; padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;}

        /* AVATAR */
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #eee; }

        .btn-sm { padding: 8px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
        .tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
        .tbl th { text-align: left; padding: 10px; background: #f8f9fa; border-bottom: 2px solid var(--border); }
        .tbl td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1a1d2e; color: #fff; padding: 14px 28px; border-radius: 30px; opacity: 0; transition: 0.4s; z-index: 10000; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="global-loader"><h2 style="font-family:'Prompt';">üè• ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...</h2></div>

<!-- Login -->
<div id="login-screen">
    <div class="login-box">
        <img id="login-logo" src="" style="max-height:80px; margin-bottom:15px; display:none; border-radius:12px;">
        <div class="login-logo" id="login-title" style="font-family: 'Prompt'; font-size: 24px; color: #fff; font-weight: 700; margin-bottom: 5px;">Clinic Manager Pro</div>
        <div class="login-sub" style="color: #adb5bd; font-size: 14px; margin-bottom: 30px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        <input class="login-input" id="login-username" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
        <input class="login-input" id="login-pin" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PIN)" maxlength="10">
        <button class="login-btn" id="btn-login" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="login-err" style="color:var(--danger); font-size:14px; font-weight:600; margin-top:15px; min-height: 20px;"></div>
    </div>
</div>

<!-- Nav -->
<nav class="nav" id="main-nav" style="display:none">
    <div class="nav-inner">
        <div class="nav-tab active" id="tab-form" onclick="switchPage('form', this)">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="nav-tab" id="tab-appt" onclick="switchPage('appointments', this)">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
        <div class="nav-tab" id="tab-cust" onclick="switchPage('customers', this)">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-tab" id="tab-summary" onclick="switchPage('summary', this)">üìä ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="nav-tab" id="tab-settings" style="display:none;" onclick="switchPage('settings', this)">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <img id="nav-avatar" class="avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23ccc' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/></svg>">
            <div>
                <div style="font-weight:700; color:var(--primary); font-size: 13px;" id="nav-display-name">User</div>
                <div style="font-size:10px; color:var(--text2); display:flex; align-items:center; gap:4px;">
                    <span class="status-dot" id="net-status"></span> <span id="net-text">Online</span>
                </div>
            </div>
            <button onclick="location.reload()" style="background:#fff2f2; color:var(--danger); border:none; padding:6px; border-radius:6px; cursor:pointer;">‡∏≠‡∏≠‡∏Å</button>
        </div>
    </div>
</nav>

<!-- Content -->
<div id="main-content" style="display:none; padding: 0 15px; max-width: 800px; margin: 0 auto;">
    <div class="org-banner" id="ui-banner">
        <div style="display:flex; align-items:center; gap:15px;">
            <img id="ui-logo" class="org-logo" src="" style="display:none;">
            <div>
                <div class="org-name" id="ui-clinic-name" style="font-family: 'Prompt'; font-size: 18px; font-weight: 600;">Clinic System</div>
                <div style="font-size:12px; opacity:0.8;" id="ui-contact"></div>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- PAGE 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°) -->
    <!-- ============================================== -->
    <div id="page-form" class="page active">
        <!-- 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
        <div class="sec">
            <div class="sec-label">üë§ 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="frow" style="margin-bottom:10px;">
                <div class="fg" style="flex:3;"><input class="fc" id="f-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤..." type="tel"></div>
                <button class="login-btn" style="flex:1; padding:10px;" onclick="formSearchCustomer()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
            <div id="f-cust-info">
                <div class="frow">
                    <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á *</label><input class="fc" id="f-fn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"></div>
                    <div class="fg"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fc" id="f-ln" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                </div>
                <div class="frow">
                    <div class="fg"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label><input class="fc" id="f-ph" placeholder="08x-xxx-xxxx" type="tel"></div>
                    <div class="fg"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input class="fc" id="f-age" type="number"></div>
                </div>
                <div class="fg"><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input class="fc" id="f-disease" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></div>
                <label style="font-size:13px; color:var(--success); font-weight:600; display:flex; gap:8px; align-items:center;">
                    <input type="checkbox" id="f-pdpa" style="width:18px; height:18px;"> ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° PDPA
                </label>
            </div>
        </div>

        <!-- 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏• vs ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤/‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™) -->
        <div class="sec" style="background:#f8f9fa;">
            <div class="sec-label">üéØ 2. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <select class="fc" id="f-trans-type" onchange="toggleFormSections()" style="font-weight:700; color:var(--primary);">
                <option value="new">üåü ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)</option>
                <option value="old">‚è≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ / ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™ (‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô)</option>
            </select>
            
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà) -->
            <div id="f-old-order-sec" style="display:none; margin-top:10px;">
                <label style="font-size:12px; font-weight:700; color:var(--danger);">‡πÄ‡∏•‡∏∑‡∏≠‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ / ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</label>
                <select class="fc" id="f-old-order-id"><option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option></select>
            </div>
        </div>

        <!-- 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà) -->
        <div class="sec" id="f-items-sec">
            <div class="sec-label">üíâ 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div id="item-list"></div>
            <button class="btn-sm" style="background:transparent; border:1px dashed var(--primary); color:var(--primary); width:100%; margin-top:5px;" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
            
            <div class="frow" style="margin-top:15px; align-items:flex-end;">
                <div class="fg"><label>‡πÄ‡∏ã‡∏•‡∏•‡πå / ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ *</label><select class="fc" id="f-sale"></select></div>
                <div class="fg"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</label><input class="fc" id="f-total" type="text" readonly style="background:#eee; font-weight:700; color:var(--danger);"></div>
            </div>
        </div>

        <!-- 4. ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
        <div class="sec">
            <div class="sec-label">üí≥ 4. ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="frow" style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:10px;">
                <div class="fg"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label><input class="fc" id="f-pay-amt" type="number" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></div>
                <div class="fg"><label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select class="fc" id="f-pay-method"><option>‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</option><option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option><option>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option></select></div>
            </div>

            <div style="border-top:1px dashed var(--border); padding-top:10px;">
                <label style="font-size:13px; font-weight:700; color:var(--primary);">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™)</label>
                <input class="fc" id="f-usage-detail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1, ‡∏â‡∏µ‡∏î‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå...">
                <div class="frow">
                    <div class="fg"><label>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label><select class="fc" id="f-dr"></select></div>
                    <div class="fg"><label>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢/BT</label><select class="fc" id="f-bt"></select></div>
                </div>
            </div>
        </div>

        <!-- 5. ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡∏£‡∏π‡∏õ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á) -->
        <div class="sec">
            <div class="sec-label">üì∏ 5. ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
            <div class="frow">
                <label class="btn-sm" style="background:#e2eafc; color:var(--primary-dark); text-align:center; flex:1; cursor:pointer;">
                    üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                    <input type="file" id="f-photo-file" accept="image/*" style="display:none;" onchange="uploadToDrive(this)">
                </label>
                <label class="btn-sm" style="background:#ffebee; color:#c62828; text-align:center; flex:1; cursor:pointer;">
                    üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                    <input type="file" id="f-photo-cam" accept="image/*" capture="environment" style="display:none;" onchange="uploadToDrive(this)">
                </label>
            </div>
            <div id="upload-status" style="margin-top:8px; font-size:12px; text-align:center; font-weight:600;"></div>
            <input type="hidden" id="f-photo-url">
        </div>

        <button class="login-btn" id="btn-save" style="margin-bottom:20px; font-size:18px;" onclick="saveFullForm()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <!-- ============================================== -->
    <!-- PAGE 2: ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏° Export) -->
    <!-- ============================================== -->
    <div id="page-appointments" class="page">
        <div class="sec" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="sec-label" style="margin:0;">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
            <div style="display:flex; gap:8px;">
                <button class="btn-export" onclick="exportCSV('appt-list-data', 'Appointments')">üì• Export</button>
                <button class="btn-sm" style="background:var(--primary); color:#fff;" onclick="openApptModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î</button>
            </div>
        </div>
        <div id="appt-list"><div style="text-align:center; color:var(--text2); padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
    </div>

    <!-- ============================================== -->
    <!-- PAGE 3: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤, Export) -->
    <!-- ============================================== -->
    <div id="page-customers" class="page">
        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="sec-label" style="margin:0;">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                <button class="btn-export" onclick="exportCSV('cust-table-data', 'Customers')">üì• Export ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <input class="fc" id="cust-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." oninput="searchCustomer()">
            <div id="cust-results" style="margin-top:10px;"></div>
        </div>
        <div id="cust-detail-area"></div>
        <!-- ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ Export -->
        <table id="cust-table-data" style="display:none;"></table>
    </div>

    <!-- ============================================== -->
    <!-- PAGE 4: ‡∏™‡∏£‡∏∏‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏° Export) -->
    <!-- ============================================== -->
    <div id="page-summary" class="page">
        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="sec-label" style="margin:0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
                <button class="btn-export" onclick="exportCSV('sum-table', 'Summary')">üì• Export ‡∏™‡∏£‡∏∏‡∏õ</button>
            </div>
            <div class="frow" style="align-items:center; margin-bottom:15px;">
                <div class="fg" style="flex:0 0 150px;"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" class="fc" id="sum-month" onchange="loadSummary()"></div>
                <button class="btn-sm" style="background:var(--primary); color:#fff; height:42px; margin-top:18px;" onclick="loadSummary()">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:#e3f2fd; padding:15px; border-radius:12px; text-align:center;">
                    <div style="font-size:12px; color:#1565c0;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                    <div style="font-size:24px; font-weight:700; color:#0d47a1;" id="sum-total">0</div>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th style="text-align:right;">‡πÄ‡∏Ñ‡∏™</th><th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th></tr></thead>
                    <tbody id="sum-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- PAGE 5: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (UI Customization & Staff) -->
    <!-- ============================================== -->
    <div id="page-settings" class="page">
        
        <!-- UI Config -->
        <div class="sec" style="border-left: 4px solid var(--accent);">
            <div class="sec-label">üé® ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (UI)</div>
            <div class="frow">
                <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</label><input class="fc" id="set-ui-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏ß‡πá‡∏ö"></div>
            </div>
            <div class="frow">
                <div class="fg"><label>‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô / ‡∏õ‡∏∏‡πà‡∏°)</label><input type="color" class="fc" id="set-ui-primary" style="height:50px; padding:5px;"></div>
                <div class="fg"><label>‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label><input type="color" class="fc" id="set-ui-bg" style="height:50px; padding:5px;"></div>
            </div>
            <div class="fg"><label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠)</label><input class="fc" id="set-ui-contact" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£, Line ID"></div>
            <div class="fg"><label>‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)</label>
                <input type="file" class="fc" accept="image/*" onchange="uploadLogo(this)">
                <input type="hidden" id="set-ui-logo">
            </div>
            <button class="login-btn" style="padding:10px; font-size:14px; margin-top:10px;" onclick="saveUISettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡πá‡∏ö</button>
        </div>

        <div class="sec">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="sec-label" style="margin:0;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                <button class="btn-sm" style="background:var(--success); color:#fff;" onclick="openStaffModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="staff-table"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ / Modal ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) -->
<div id="modal-staff" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:350px; padding:20px; border-radius:12px;">
        <h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
        <input class="fc" id="stf-user" placeholder="Username">
        <input class="fc" id="stf-pin" placeholder="PIN" maxlength="4" type="tel">
        <input class="fc" id="stf-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å">
        <select class="fc" id="stf-role">
            <option value="Sales">Sales (‡πÄ‡∏ã‡∏•‡∏•‡πå)</option>
            <option value="BT">BT (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢)</option>
            <option value="Dr">Dr (‡πÅ‡∏û‡∏ó‡∏¢‡πå)</option>
            <option value="Manager">Manager</option>
            <option value="Admin">Admin</option>
        </select>
        <div style="display:flex; gap:10px;"><button class="login-btn" style="background:#ddd; color:#000;" onclick="document.getElementById('modal-staff').style.display='none'">‡∏õ‡∏¥‡∏î</button><button class="login-btn" onclick="addStaff()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
</div>

<div id="toast">‚úÖ ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

<script>
    let currentUser = null;
    let staffList = [];
    let systemSettings = {};

    // --- System Status Check ---
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    function updateStatus() {
        const d = document.getElementById('net-status'); const t = document.getElementById('net-text');
        if(navigator.onLine) { d.classList.remove('offline'); t.textContent = 'Online'; } 
        else { d.classList.add('offline'); t.textContent = 'Offline'; showToast('‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', true); }
    }

    window.onload = async () => {
        updateStatus();
        // ‡πÇ‡∏´‡∏•‡∏î Setting ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô Login ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        try {
            const res = await fetch('/.netlify/functions/api', { method: 'POST', body: JSON.stringify({ action: 'get_settings' }) });
            const data = await res.json();
            if(data.success && data.settings) applyTheme(data.settings);
        } catch(e) {}
        setTimeout(() => { document.getElementById('global-loader').style.display = 'none'; }, 500);
        addItemRow(); document.getElementById('sum-month').value = new Date().toISOString().slice(0, 7);
    };

    async function apiCall(action, payload) {
        if(!navigator.onLine) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', true); return {success:false}; }
        try {
            const res = await fetch('/.netlify/functions/api', { method: 'POST', body: JSON.stringify({ action, payload }) });
            return await res.json();
        } catch (e) { return { success: false, message: 'Connection Error' }; }
    }

    function applyTheme(s) {
        systemSettings = s;
        if(s.ui_primary_color) { document.documentElement.style.setProperty('--primary', s.ui_primary_color); document.documentElement.style.setProperty('--primary-dark', s.ui_primary_color); }
        if(s.ui_bg_color) document.documentElement.style.setProperty('--bg', s.ui_bg_color);
        if(s.clinic_name) { document.getElementById('ui-clinic-name').textContent = s.clinic_name; document.getElementById('login-title').textContent = s.clinic_name; }
        if(s.contact_info) document.getElementById('ui-contact').textContent = s.contact_info;
        if(s.logo_url) { 
            const ls = document.querySelectorAll('.org-logo, #login-logo');
            ls.forEach(l => { l.src = s.logo_url; l.style.display = 'block'; });
        }
        
        // Fill settings form
        document.getElementById('set-ui-name').value = s.clinic_name || '';
        document.getElementById('set-ui-primary').value = s.ui_primary_color || '#4361ee';
        document.getElementById('set-ui-bg').value = s.ui_bg_color || '#f4f6fb';
        document.getElementById('set-ui-contact').value = s.contact_info || '';
        document.getElementById('set-ui-logo').value = s.logo_url || '';
    }

    async function doLogin() {
        const res = await apiCall('login', { username: document.getElementById('login-username').value, pin: document.getElementById('login-pin').value });
        if (res.success) {
            currentUser = res.user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'block'; document.getElementById('main-content').style.display = 'block';
            document.getElementById('nav-display-name').textContent = currentUser.display_name;
            if(currentUser.avatar_url) document.getElementById('nav-avatar').src = currentUser.avatar_url;
            await initSystem();
        } else document.getElementById('login-err').textContent = res.message;
    }

    async function initSystem() {
        const res = await apiCall('get_staff', {});
        if (res.success) { staffList = res.staff; renderSelects(); }
        
        const role = currentUser.role;
        if (['Owner', 'Admin', 'Manager'].includes(role)) { document.getElementById('tab-settings').style.display = 'block'; loadAllStaff(); }
        
        if (['Sales', 'BT', 'Dr'].includes(role)) {
            const s = document.getElementById('f-sale');
            s.value = currentUser.id; s.disabled = true; s.style.background = '#eee';
        }
    }

    function renderSelects() {
        document.getElementById('f-sale').innerHTML = '<option value="">-‡πÄ‡∏ã‡∏•‡∏•‡πå-</option>' + staffList.filter(s=>['Sales','Manager','Owner','Admin'].includes(s.role)).map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('f-dr').innerHTML = '<option value="">-‡πÅ‡∏û‡∏ó‡∏¢‡πå-</option>' + staffList.filter(s=>s.role==='Dr').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
        document.getElementById('f-bt').innerHTML = '<option value="">-BT-</option>' + staffList.filter(s=>s.role==='BT').map(s=>`<option value="${s.id}">${s.display_name}</option>`).join('');
    }

    // --- FORM LOGIC (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà) ---
    function toggleFormSections() {
        const t = document.getElementById('f-trans-type').value;
        if(t === 'new') { document.getElementById('f-items-sec').style.display='block'; document.getElementById('f-old-order-sec').style.display='none'; }
        else { document.getElementById('f-items-sec').style.display='none'; document.getElementById('f-old-order-sec').style.display='block'; }
    }

    async function formSearchCustomer() {
        const p = document.getElementById('f-search').value;
        if(!p) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', true);
        const res = await apiCall('search_customers', {query: p});
        if(res.success && res.customers.length > 0) {
            const c = res.customers[0];
            document.getElementById('f-fn').value = c.first_name; document.getElementById('f-ln').value = c.last_name||'';
            document.getElementById('f-ph').value = c.phone; document.getElementById('f-age').value = c.age||'';
            document.getElementById('f-disease').value = c.disease||'';
            showToast('‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà Dropdown ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤
            const dRes = await apiCall('get_customer_full_detail', {customerId: c.id});
            if(dRes.success) {
                const sel = document.getElementById('f-old-order-id');
                sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå --</option>' + 
                    dRes.orders.map(o => {
                        const paid = dRes.payments.filter(p=>p.order_id===o.id).reduce((s,p)=>s+parseFloat(p.amount),0);
                        return `<option value="${o.id}">${new Date(o.created_at).toLocaleDateString()} (‡∏Ñ‡πâ‡∏≤‡∏á ${(o.total_price - paid).toLocaleString()}‡∏ø)</option>`;
                    }).join('');
            }
        } else { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', true); }
    }

    function addItemRow() {
        const div = document.createElement('div'); div.className = 'frow item-row';
        div.innerHTML = `<div class="fg" style="flex:2"><input class="fc item-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"></div><div class="fg" style="flex:1"><input class="fc item-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" oninput="calcTotal()"></div><button onclick="this.parentElement.remove(); calcTotal()" style="color:red; background:none; border:none; padding:10px;">x</button>`;
        document.getElementById('item-list').appendChild(div);
    }
    function calcTotal() {
        let sum = 0; document.querySelectorAll('.item-row').forEach(r => sum += +(r.querySelector('.item-price').value || 0));
        document.getElementById('f-total').value = sum.toLocaleString(); return sum;
    }

    async function saveFullForm() {
        const btn = document.getElementById('btn-save'); btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;
        const t = document.getElementById('f-trans-type').value;
        
        const payload = {
            firstName: document.getElementById('f-fn').value, lastName: document.getElementById('f-ln').value,
            phone: document.getElementById('f-ph').value, age: document.getElementById('f-age').value,
            disease: document.getElementById('f-disease').value, pdpa: document.getElementById('f-pdpa').checked,
            existingOrderId: t === 'old' ? document.getElementById('f-old-order-id').value : null,
            items: [], totalPrice: 0, saleStaffId: document.getElementById('f-sale').value, saleStaffName: document.getElementById('f-sale').selectedOptions[0]?.text,
            paymentAmount: parseFloat(document.getElementById('f-pay-amt').value || 0), paymentMethod: document.getElementById('f-pay-method').value,
            usageDetails: document.getElementById('f-usage-detail').value, drId: document.getElementById('f-dr').value, btId: document.getElementById('f-bt').value,
            imageUrl: document.getElementById('f-photo-url').value, currentUserId: currentUser.id
        };

        if(t === 'new') {
            document.querySelectorAll('.item-row').forEach(r => { if(r.querySelector('.item-name').value) payload.items.push({ name: r.querySelector('.item-name').value, price: +r.querySelector('.item-price').value }); });
            payload.totalPrice = calcTotal();
            if(!payload.saleStaffId || payload.items.length===0) { showToast('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true); btn.disabled=false; return; }
        } else {
            if(!payload.existingOrderId) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true); btn.disabled=false; return; }
        }

        const res = await apiCall('save_order', payload);
        if (res.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); setTimeout(() => location.reload(), 1500); }
        else { showToast('Error: '+res.message, true); btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; btn.disabled = false; }
    }

    // --- UPLOAD LOGIC ---
    async function uploadToDrive(input) {
        const file = input.files[0]; if(!file) return;
        document.getElementById('upload-status').textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Img_${Date.now()}.jpg` });
            if(res.success) { document.getElementById('f-photo-url').value = res.link; document.getElementById('upload-status').innerHTML='<span style="color:green;">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>'; }
            else { document.getElementById('upload-status').innerHTML='<span style="color:red;">‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>'; }
        }; r.readAsDataURL(file);
    }
    
    async function uploadLogo(input) {
        const file = input.files[0]; if(!file) return; showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ...');
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Logo_${Date.now()}.png` });
            if(res.success) { document.getElementById('set-ui-logo').value = res.link; showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        }; r.readAsDataURL(file);
    }

    async function uploadAvatar(input, userId) {
        const file = input.files[0]; if(!file) return; showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...');
        const r = new FileReader();
        r.onload = async(e) => {
            const res = await apiCall('upload_image', { base64: e.target.result, fileName: `Avatar_${userId}.jpg` });
            if(res.success) { 
                await apiCall('manage_staff', { subAction: 'update_avatar', id: userId, avatar_url: res.link });
                showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadAllStaff(); 
            }
        }; r.readAsDataURL(file);
    }

    // --- SETTINGS ---
    async function saveUISettings() {
        const p = {
            action: 'save_settings',
            clinic_name: document.getElementById('set-ui-name').value,
            ui_primary_color: document.getElementById('set-ui-primary').value,
            ui_bg_color: document.getElementById('set-ui-bg').value,
            contact_info: document.getElementById('set-ui-contact').value,
            logo_url: document.getElementById('set-ui-logo').value,
            tg_token: systemSettings.tg_token, tg_chat_id: systemSettings.tg_chat_id, alert_new_order: systemSettings.alert_new_order // keep old TG
        };
        const res = await apiCall('save_settings', p);
        if(res.success) { showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß'); applyTheme(p); }
    }

    async function loadAllStaff() {
        const res = await apiCall('get_staff', {}); // ‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        let html = '';
        if(res.success) {
            res.staff.forEach(u => {
                const avt = u.avatar_url || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23ccc' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/></svg>";
                html += `<tr>
                    <td><label style="cursor:pointer;"><img src="${avt}" class="avatar"><input type="file" style="display:none;" accept="image/*" onchange="uploadAvatar(this, ${u.id})"></label></td>
                    <td>${u.display_name} <div style="font-size:11px; color:#aaa;">@${u.username}</div></td>
                    <td><span style="background:#eee; padding:2px 6px; border-radius:4px;">${u.role}</span></td>
                    <td><button class="btn-sm" style="color:red;" onclick="delStaff(${u.id})">‡∏•‡∏ö</button></td>
                </tr>`;
            });
        }
        document.getElementById('staff-table').innerHTML = html;
    }
    
    function openStaffModal() { document.getElementById('modal-staff').style.display='flex'; }
    async function addStaff() {
        const payload = { subAction: 'add', username: document.getElementById('stf-user').value, pin: document.getElementById('stf-pin').value, name: document.getElementById('stf-name').value, role: document.getElementById('stf-role').value };
        const res = await apiCall('manage_staff', payload);
        if(res.success) { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); document.getElementById('modal-staff').style.display='none'; loadAllStaff(); }
    }
    async function delStaff(id) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?')) { await apiCall('manage_staff', { subAction: 'delete', id }); loadAllStaff(); } }

    // --- EXPORT CSV ---
    function exportCSV(tableId, filename) {
        let csv = [];
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        let rows = document.querySelectorAll(`#${tableId} tr`);
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î) ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏≠‡∏Å
        if(rows.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export', true); return; }
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
            csv.push(row.join(","));
        }
        downloadCSV(csv.join("\n"), filename+'.csv');
    }
    function downloadCSV(csv, filename) {
        let csvFile = new Blob(["\ufeff"+csv], {type: "text/csv;charset=utf-8;"});
        let link = document.createElement("a"); link.download = filename; link.href = window.URL.createObjectURL(csvFile);
        link.style.display = "none"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // UI Helpers
    function switchPage(p, el) { document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); el.classList.add('active'); }
    function showToast(m, err=false) { const t = document.getElementById('toast'); t.textContent=m; t.style.background=err?'var(--danger)':'var(--text)'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
</script>
</body>
</html>
