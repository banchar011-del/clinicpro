<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinic Manager Pro V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --primary-dark: #2d47c9; --success: #06d6a0; --warning: #ffd166; --danger: #ef476f; --accent: #f72585; --bg: #f4f6fb; --surface: #ffffff; --text: #1a1d2e; --text2: #6c757d; --border: #e2e6f0; --rs: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }

        /* ===== LOADER & LOGIN ===== */
        #global-loader { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 50%, #1a1d2e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s; }
        .loader-logo { font-family: 'Prompt', sans-serif; font-size: 26px; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .loader-bar { width: 220px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .loader-fill { height: 100%; width: 50%; background: var(--primary); animation: loadAnim 1.5s infinite; }
        @keyframes loadAnim { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1d2e 0%, #2d3561 50%, #1a1d2e 100%); display: flex; align-items: center; justify-content: center; z-index: 9000; padding: 16px; }
        .login-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12); border-radius: 24px; padding: 40px; width: 100%; max-width: 380px; text-align: center; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; text-align: center; font-size: 16px; transition: 0.3s; }
        .login-input:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.15); }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; font-family: 'Prompt', sans-serif; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4); }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(67, 97, 238, 0.6); }

        /* ===== UI COMPONENTS ===== */
        .nav { background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .nav-inner { display: flex; align-items: center; padding: 0 10px; overflow-x: auto; max-width: 800px; margin: 0 auto; }
        .nav-tab { padding: 16px 12px; cursor: pointer; font-family: 'Prompt', sans-serif; font-size: 14px; font-weight: 600; color: var(--text2); white-space: nowrap; transition: 0.3s; }
        .nav-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .org-banner { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; padding: 20px; display: flex; align-items: center; gap: 15px; border-radius: 0 0 16px 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sec { background: var(--surface); border-radius: var(--rs); padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .sec-label { font-family: 'Prompt', sans-serif; font-weight: 700; color: var(--primary); font-size: 15px; margin-bottom: 12px; border-bottom: 2px solid #f0f4ff; padding-bottom: 8px; }
        .fc { width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fafbfe; margin-bottom: 10px; transition: 0.3s; }
        .fc:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        .frow { display: flex; gap: 12px; flex-wrap: wrap; }
        .fg { flex: 1; min-width: 120px; display: flex; flex-direction: column; }
        .fg label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; }

        .btn-outline { background: transparent; border: 1.5px dashed var(--primary); color: var(--primary); font-weight: 600; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-outline:hover { background: #f0f4ff; border-style: solid; }

        .expand-bar { background: linear-gradient(135deg, #f0f4ff 0%, #e2eafc 100%); border: 1px solid #d7e3fc; border-radius: 12px; padding: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .expand-icon { background: var(--primary); color: #fff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: 0.3s; }
        .expand-text { font-weight: 600; color: var(--primary-dark); font-size: 13px; }

        .file-upload-wrapper { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 12px; background: #f8fafc; cursor: pointer; position: relative; }
        .file-upload-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1a1d2e; color: #fff; padding: 14px 28px; border-radius: 30px; opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10000; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- Loader -->
<div id="global-loader">
    <div class="loader-logo">üè• Clinic Manager Pro</div>
    <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<!-- Login Screen -->
<div id="login-screen">
    <div class="login-box">
        <div class="login-logo" style="font-family: 'Prompt'; font-size: 24px; color: #fff; font-weight: 700; margin-bottom: 5px;">üè• Clinic Manager Pro</div>
        <div class="login-sub" style="color: #adb5bd; font-size: 14px; margin-bottom: 30px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£</div>
        <input class="login-input" id="login-username" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)">
        <input class="login-input" id="login-pin" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (PIN)" maxlength="10">
        <button class="login-btn" id="btn-login" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div id="login-err" style="color:#ef476f; font-size:14px; font-weight:600; margin-top:15px; min-height: 20px;"></div>
    </div>
</div>

<!-- Navigation -->
<nav class="nav" id="main-nav" style="display:none">
    <div class="nav-inner">
        <div class="nav-tab active" onclick="switchPage('form', this)">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
        <div class="nav-tab" onclick="switchPage('customers', this)">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-tab" onclick="switchPage('summary', this)">üìä ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="nav-tab" id="tab-settings" style="display:none;" onclick="switchPage('settings', this)">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        <div class="nav-user" style="margin-left:auto; padding-right:15px; display: flex; align-items: center; gap: 10px;">
            <span id="nav-display-name" style="font-weight:700; color:var(--primary); font-size: 14px;"></span>
            <button onclick="location.reload()" style="background:#fff2f2; border:1px solid #ffcaca; border-radius: 8px; padding: 6px 12px; color:var(--danger); cursor:pointer; font-size: 12px; font-weight: 600;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div id="main-content" style="display:none; padding: 0 15px 80px 15px; max-width: 800px; margin: 0 auto;">
    <div class="org-banner">
        <div style="font-size: 24px;">‚ú®</div>
        <div class="org-name" style="font-family: 'Prompt'; font-size: 18px; font-weight: 600;">NT Design Clinic System</div>
    </div>

    <!-- PAGE: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Form) -->
    <div id="page-form" class="page active">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
        <div class="sec">
            <div class="sec-label">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="frow">
                <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠ *</label><input class="fc" id="f-fn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"></div>
                <div class="fg"><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fc" id="f-ln" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
            </div>
            <input class="fc" id="f-ph" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (08x-xxx-xxxx)" type="tel">
            
            <div style="margin-top:5px; display:flex; align-items:center; gap:10px; padding:12px; background:#f0fff8; border-radius:8px; border:1px solid #b2dfdb">
                <input type="checkbox" id="f-pdpa" style="width:20px; height:20px; accent-color: var(--success);">
                <span style="font-size:13px; color:#047857; font-weight:600;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (PDPA)</span>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
            <div class="expand-bar" onclick="toggleExtra()">
                <div class="expand-icon" id="extra-icon">‚ûï</div>
                <div class="expand-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß)</div>
            </div>
            <div id="extra-body" style="display:none; padding:15px; border:1px solid #e2eafc; border-top:none; border-radius:0 0 12px 12px; background: #fff;">
                <div class="frow">
                    <div class="fg"><label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input class="fc" id="f-age" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 25"></div>
                    <div class="fg"><label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input class="fc" id="f-disease" placeholder="‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á"></div>
                </div>
            </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
        <div class="sec">
            <div class="sec-label">üíâ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div id="item-list">
                <!-- ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1 ‡πÅ‡∏ñ‡∏ß -->
                <div class="frow item-row" style="margin-bottom:10px; align-items: center;">
                    <div class="fg" style="flex:2;"><input class="fc item-name" style="margin:0" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *" required></div>
                    <div class="fg" style="flex:1;"><input class="fc item-price" style="margin:0" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) *" required oninput="calculateTotal()"></div>
                    <button onclick="removeItemRow(this)" style="color:var(--danger); background:none; border:none; padding:10px; font-size:18px; cursor:pointer;" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‚ùå</button>
                </div>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:5px;" onclick="addItemRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
            
            <div class="frow" style="margin-top:20px; align-items: flex-end;">
                <div class="fg"><label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏Ñ‡∏™ *</label><select class="fc" id="f-sale1"></select></div>
                <div class="fg">
                    <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input class="fc" id="f-total" type="text" readonly style="background: #e9ecef; font-weight: 700; color: var(--primary-dark); font-size: 16px;">
                </div>
            </div>
        </div>

        <!-- ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ -->
        <div class="sec">
            <div class="sec-label">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ / ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥</div>
            <div class="file-upload-wrapper">
                <div style="font-size: 24px; margin-bottom: 5px;">üì§</div>
                <div style="font-weight: 600; color: var(--primary);">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
                <div style="font-size: 12px; color: var(--text2); margin-top: 5px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB</div>
                <input type="file" id="f-photo" accept="image/jpeg, image/png" onchange="uploadToDrive(this)">
            </div>
            <div id="upload-status" style="margin-top: 10px; font-size: 13px; font-weight: 600; text-align: center;"></div>
        </div>

        <button class="login-btn" id="btn-save" style="margin-bottom: 20px; font-size: 18px;" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- PAGE: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
    <div id="page-customers" class="page">
        <div class="sec">
            <div class="sec-label">üë• ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Coming Soon)</div>
            <p style="color: var(--text2); font-size: 14px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
        </div>
    </div>

    <!-- PAGE: ‡∏™‡∏£‡∏∏‡∏õ -->
    <div id="page-summary" class="page">
        <div class="sec">
            <div class="sec-label">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Coming Soon)</div>
            <p style="color: var(--text2); font-size: 14px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
        </div>
    </div>

    <!-- PAGE: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
    <div id="page-settings" class="page">
        <div class="sec">
            <div class="sec-label">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</div>
            <p style="color: var(--text2); font-size: 14px;">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
        </div>
    </div>
</div>

<div id="toast">‚úÖ ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

<!-- ========================================== -->
<!-- JAVASCRIPT LOGIC (‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏à‡∏≤‡∏Å api.js, auth.js, app.js) -->
<!-- ========================================== -->
<script>
    // --- Global Variables ---
    let currentUser = null;

    // --- System Boot ---
    window.onload = () => {
        setTimeout(() => { 
            const loader = document.getElementById('global-loader');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        }, 800);
    };

    // --- API Core (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ jsapi.js) ---
    async function apiCall(action, payload) {
        try {
            const response = await fetch('/.netlify/functions/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            return { success: false, message: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà' };
        }
    }

    // --- Authentication (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ jsauth.js) ---
    async function doLogin() {
        const username = document.getElementById('login-username').value.trim();
        const pin = document.getElementById('login-pin').value;
        const errEl = document.getElementById('login-err');
        const btn = document.getElementById('btn-login');

        if (!username || !pin) { 
            errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™ PIN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'; 
            return; 
        }

        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
        btn.disabled = true;
        errEl.textContent = '';

        const res = await apiCall('login', { username, pin });

        if (res.success) {
            currentUser = res.user;
            
            // Switch UI
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'block';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('nav-display-name').textContent = currentUser.display_name;

            // Setup Permissions
            applyPermissions();
        } else {
            errEl.textContent = res.message || '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            btn.disabled = false;
        }
    }

    function applyPermissions() {
        const saleSelect = document.getElementById('f-sale1');
        const settingsTab = document.getElementById('tab-settings');

        // Admin/Owner ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        if (['Admin', 'Owner'].includes(currentUser.role)) {
            settingsTab.style.display = 'block';
        }

        // ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£
        if (['Sales', 'BT', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'].includes(currentUser.role)) {
            saleSelect.innerHTML = `<option value="${currentUser.display_name}">${currentUser.display_name}</option>`;
            saleSelect.disabled = true;
            saleSelect.style.background = '#e9ecef';
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ
            loadSalesList();
        }
    }

    async function loadSalesList() {
        const saleSelect = document.getElementById('f-sale1');
        saleSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
        
        const res = await apiCall('get_staff', {});
        if (res.success && res.staff) {
            let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ --</option>';
            res.staff.forEach(s => { 
                html += `<option value="${s.display_name}">${s.display_name}</option>`; 
            });
            saleSelect.innerHTML = html;
        } else {
            saleSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
        }
    }

    // --- Application Logic (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ jsapp.js) ---
    function switchPage(pageId, el) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        el.classList.add('active');
    }

    function toggleExtra() {
        const b = document.getElementById('extra-body');
        const i = document.getElementById('extra-icon');
        const isShow = b.style.display === 'block';
        b.style.display = isShow ? 'none' : 'block';
        i.textContent = isShow ? '‚ûï' : '‚ûñ';
        i.style.background = isShow ? 'var(--primary)' : 'var(--danger)';
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    function addItemRow() {
        const div = document.createElement('div');
        div.className = 'frow item-row';
        div.style.marginBottom = '10px';
        div.style.alignItems = 'center';
        div.innerHTML = `
            <div class="fg" style="flex:2;"><input class="fc item-name" style="margin:0" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *" required></div>
            <div class="fg" style="flex:1;"><input class="fc item-price" style="margin:0" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) *" required oninput="calculateTotal()"></div>
            <button onclick="removeItemRow(this)" style="color:var(--danger); background:none; border:none; padding:10px; font-size:18px; cursor:pointer;" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‚ùå</button>
        `;
        document.getElementById('item-list').appendChild(div);
    }

    function removeItemRow(btn) {
        const rows = document.querySelectorAll('.item-row');
        if(rows.length > 1) {
            btn.parentElement.remove();
            calculateTotal();
        } else {
            showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true);
        }
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const priceVal = row.querySelector('.item-price').value;
            if (priceVal) {
                total += parseFloat(priceVal);
            }
        });
        document.getElementById('f-total').value = total.toLocaleString('th-TH');
        return total;
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
    async function uploadToDrive(input) {
        const file = input.files[0];
        if (!file) return;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB
        if (file.size > 5 * 1024 * 1024) {
            showToast('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)', true);
            input.value = '';
            return;
        }
        
        const status = document.getElementById('upload-status');
        status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Drive...';
        status.style.color = 'var(--warning)';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const res = await apiCall('upload_image', {
                base64: e.target.result,
                fileName: `Slip_${currentUser.username}_${Date.now()}.${file.name.split('.').pop()}`
            });

            if (res.success) {
                status.textContent = '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                status.style.color = 'var(--success)';
                input.setAttribute('data-link', res.link);
            } else {
                status.textContent = '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + res.message;
                status.style.color = 'var(--danger)';
                input.removeAttribute('data-link');
            }
        };
        reader.readAsDataURL(file);
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function saveOrder() {
        const fn = document.getElementById('f-fn').value.trim();
        const saleStaff = document.getElementById('f-sale1').value;
        const btn = document.getElementById('btn-save');

        if (!fn) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', true); return; }
        if (!saleStaff) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢', true); return; }

        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const items = [];
        let hasEmptyItem = false;
        document.querySelectorAll('.item-row').forEach(row => {
            const name = row.querySelector('.item-name').value.trim();
            const price = parseFloat(row.querySelector('.item-price').value);
            
            if (!name || isNaN(price)) { hasEmptyItem = true; }
            else { items.push({ name, price }); }
        });

        if (hasEmptyItem || items.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', true);
            return;
        }

        btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        btn.disabled = true;

        const payload = {
            firstName: fn,
            lastName: document.getElementById('f-ln').value.trim(),
            phone: document.getElementById('f-ph').value.trim(),
            pdpa: document.getElementById('f-pdpa').checked,
            age: document.getElementById('f-age').value,
            disease: document.getElementById('f-disease').value.trim(),
            items: items,
            totalPrice: calculateTotal(),
            saleStaff: saleStaff,
            imageUrl: document.getElementById('f-photo').getAttribute('data-link') || null
        };

        const res = await apiCall('save_order', payload);
        
        if (res.success) {
            showToast('üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            setTimeout(() => { location.reload(); }, 2000);
        } else {
            showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.message, true);
            btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
            btn.disabled = false;
        }
    }

    // UI Utilities
    function showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.background = isError ? 'var(--danger)' : '#1a1d2e';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>
</body>
</html>